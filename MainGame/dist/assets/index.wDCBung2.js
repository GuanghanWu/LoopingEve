(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();const n=d=>document.getElementById(d);class b{game;constructor(e){this.game=e}init(){this.game.player={...this.game.config.player.initial,weapon:null,armor:null,learnedSkills:["powerStrike"],equippedSkills:["powerStrike"],selectedSkill:"powerStrike",skillCooldowns:{},attackCount:0}}getTotalAtk(){let e=this.game.player.atk;if(this.game.player.weapon){const t=this.game.config.equipment.weapons.find(s=>s.id===this.game.player.weapon);t&&(e+=t.atk)}return e}getTotalDef(){let e=this.game.player.def;if(this.game.player.armor){const t=this.game.config.equipment.armors.find(s=>s.id===this.game.player.armor);t&&(e+=t.def)}return e}getTotalComboRate(){let e=this.game.player.comboRate;if(this.game.player.weapon){const t=this.game.config.equipment.weapons.find(s=>s.id===this.game.player.weapon);t?.comboRate&&(e+=t.comboRate)}if(this.game.player.armor){const t=this.game.config.equipment.armors.find(s=>s.id===this.game.player.armor);t?.comboRate&&(e+=t.comboRate)}return e}getTotalComboDamage(){let e=this.game.player.comboDamage;if(this.game.player.weapon){const t=this.game.config.equipment.weapons.find(s=>s.id===this.game.player.weapon);t?.comboDamage&&(e+=t.comboDamage)}if(this.game.player.armor){const t=this.game.config.equipment.armors.find(s=>s.id===this.game.player.armor);t?.comboDamage&&(e+=t.comboDamage)}return e}getTotalCounterRate(){let e=this.game.player.counterRate;if(this.game.player.weapon){const t=this.game.config.equipment.weapons.find(s=>s.id===this.game.player.weapon);t?.counterRate&&(e+=t.counterRate)}if(this.game.player.armor){const t=this.game.config.equipment.armors.find(s=>s.id===this.game.player.armor);t?.counterRate&&(e+=t.counterRate)}return e}getTotalCounterDamage(){let e=this.game.player.counterDamage;if(this.game.player.weapon){const t=this.game.config.equipment.weapons.find(s=>s.id===this.game.player.weapon);t?.counterDamage&&(e+=t.counterDamage)}if(this.game.player.armor){const t=this.game.config.equipment.armors.find(s=>s.id===this.game.player.armor);t?.counterDamage&&(e+=t.counterDamage)}return e}getTotalBlockRate(){let e=this.game.player.blockRate;if(this.game.player.weapon){const t=this.game.config.equipment.weapons.find(s=>s.id===this.game.player.weapon);t?.blockRate&&(e+=t.blockRate)}if(this.game.player.armor){const t=this.game.config.equipment.armors.find(s=>s.id===this.game.player.armor);t?.blockRate&&(e+=t.blockRate)}return e}getTotalBlockReduction(){let e=this.game.player.blockReduction;if(this.game.player.weapon){const t=this.game.config.equipment.weapons.find(s=>s.id===this.game.player.weapon);t?.blockReduction&&(e+=t.blockReduction)}if(this.game.player.armor){const t=this.game.config.equipment.armors.find(s=>s.id===this.game.player.armor);t?.blockReduction&&(e+=t.blockReduction)}return Math.min(e,.8)}getTotalMaxShield(){let e=this.game.player.maxShield;if(this.game.player.weapon){const t=this.game.config.equipment.weapons.find(s=>s.id===this.game.player.weapon);t?.maxShield&&(e+=t.maxShield)}if(this.game.player.armor){const t=this.game.config.equipment.armors.find(s=>s.id===this.game.player.armor);t?.maxShield&&(e+=t.maxShield)}return e}getUnlockedSkillSlots(){const e=this.game.player.level;return this.game.config.player.skillSlots.filter(t=>e>=t).length}levelUp(){const e=this.game.config.player.levelUp;for(;this.game.player.exp>=this.game.player.maxEXP;)this.game.player.exp-=this.game.player.maxEXP,this.game.player.level++,this.game.player.maxHP+=e.hp,this.game.player.hp=Math.min(this.game.player.hp+e.hp,this.game.player.maxHP),this.game.player.atk+=e.atk,this.game.player.def+=e.def,this.game.player.maxEXP=Math.floor(this.game.player.maxEXP*e.expMultiplier),this.game.ui.showLevelUp(this.game.player.level,e)}equipSkill(e){const t=this.game.player.equippedSkills;if(t.includes(e))return null;const s=this.getUnlockedSkillSlots();let a=null;if(t.length>=s&&t[0]){const i=this.game.config.skills.find(o=>o.id===t[0]);a=i?i.name:t[0],t.shift()}return t.push(e),a}unequipSkill(e){return e<0||e>=this.game.player.equippedSkills.length?!1:(this.game.player.equippedSkills.splice(e,1),!0)}checkSkillUnlock(){const e=this.game.player.level;this.game.config.skills.forEach(t=>{if(this.game.player.learnedSkills.includes(t.id)||t.unlock==="default"||t.unlock==="scroll")return;const s=t.unlock.match(/^level(\d+)$/);if(s&&e>=parseInt(s[1])&&(this.game.player.learnedSkills.push(t.id),this.game.ui.log(`âœ¨ å­¦ä¼šæ–°æŠ€èƒ½ï¼š${t.icon} ${t.name}ï¼`),!this.game.player.equippedSkills.includes(t.id))){const a=this.getUnlockedSkillSlots();this.game.player.equippedSkills.length<a&&this.game.player.equippedSkills.push(t.id)}})}reduceCooldowns(){Object.keys(this.game.player.skillCooldowns).forEach(e=>{this.game.player.skillCooldowns[e]>0&&this.game.player.skillCooldowns[e]--}),this.game.ui.updateSkillName()}migrateOldData(){this.game.player.learnedSkills||(this.game.player.learnedSkills=["powerStrike"],this.game.player.equippedSkills=["powerStrike"],this.game.player.skillCooldowns={}),this.game.player.selectedSkill||(this.game.player.selectedSkill=this.game.player.learnedSkills[0]||"powerStrike"),this.game.player.weapon||(this.game.player.weapon=null),this.game.player.armor||(this.game.player.armor=null),this.game.player.comboRate===void 0&&(this.game.player.comboRate=0,this.game.player.comboDamage=.5,this.game.player.counterRate=0,this.game.player.counterDamage=.5,this.game.player.blockRate=0,this.game.player.blockReduction=.3,this.game.player.shield=0,this.game.player.maxShield=0)}unequipItem(e){e==="weapons"?this.game.player.weapon=null:this.game.player.armor=null}}class x{game;constructor(e){this.game=e}init(){this.game.inventory={slots:this.game.config.inventory.initialSlots,items:[]}}addItem(e,t=1){const a=[...this.game.config.items.consumables,...this.game.config.items.materials,...this.game.config.items.scrolls].find(o=>o.id===e);if(!a)return;const i=this.game.inventory.items.find(o=>o.id===e);if(i){const o=Math.min(i.count+t,a.stackMax),l=o-i.count;i.count=o,l>0&&this.game.ui.log(`ğŸ“¦ ${a.icon} ${a.name} +${l}`)}else{if(this.game.inventory.items.length>=this.game.inventory.slots){this.game.ui.log(`âš ï¸ èƒŒåŒ…å·²æ»¡ï¼Œ${a.name} ä¸¢å¤±ï¼`);return}this.game.inventory.items.push({id:e,count:Math.min(t,a.stackMax)}),this.game.ui.log(`ğŸ“¦ ${a.icon} ${a.name} +${t}`)}}removeItem(e,t=1){const s=this.game.inventory.items.findIndex(a=>a.id===e);return s===-1?!1:(this.game.inventory.items[s].count-=t,this.game.inventory.items[s].count<=0&&this.game.inventory.items.splice(s,1),!0)}getItemCount(e){const t=this.game.inventory.items.find(s=>s.id===e);return t?t.count:0}grantLoot(e){const t=this.game.config.lootTable[e];t&&t.forEach(s=>{if(Math.random()<s.rate){const a=Math.floor(Math.random()*(s.maxCount-s.minCount+1))+s.minCount;this.addItem(s.itemId,a)}})}useItem(e){const t=this.game.inventory.items[e];if(!t)return;const s=this.game.config.items.consumables.find(i=>i.id===t.id);if(!s||!s.heal)return;const a=Math.min(s.heal,this.game.player.maxHP-this.game.player.hp);a<=0||(this.game.player.hp+=a,this.removeItem(t.id,1),this.game.ui.log(`ğŸ’š ä½¿ç”¨ ${s.name}ï¼Œæ¢å¤ <span class="heal">${a}</span> HP`),this.game.save(),this.game.ui.render(),this.game.ui.renderInventoryPanel())}useItemInBattle(e){if(!this.game.inBattle)return;const t=this.game.config.items.consumables.find(a=>a.id===e);if(!t||!t.heal)return;const s=Math.min(t.heal,this.game.player.maxHP-this.game.player.hp);this.game.player.hp+=s,this.removeItem(e,1),this.game.ui.log(`ğŸ’š ä½¿ç”¨ ${t.name}ï¼Œæ¢å¤ <span class="heal">${s}</span> HP`),this.game.ui.showDamagePopup(s,!0),document.getElementById("itemModal")?.classList.remove("show"),this.game.save(),this.game.ui.render(),this.game.battle.enemyAttack()}smartUseItem(){if(!this.game.inBattle){this.game.ui.log("âŒ éæˆ˜æ–—çŠ¶æ€ï¼");return}const e=this.game.player.maxHP-this.game.player.hp;if(e<2){this.game.ui.log("ğŸ’š æ— éœ€æ¢å¤è¡€é‡ï¼");return}const t=this.game.player.hp/this.game.player.maxHP,s=this.game.inventory.items.filter(i=>{const o=this.game.config.items.consumables.find(l=>l.id===i.id);return o&&o.heal}).map(i=>{const o=this.game.config.items.consumables.find(l=>l.id===i.id);return{...i,def:o,heal:o.heal}}).sort((i,o)=>o.heal-i.heal);if(s.length===0){this.game.ui.log("âŒ æ²¡æœ‰å¯ç”¨çš„é“å…·ï¼");return}let a=null;if(t<.3)a=s[0];else{for(const i of s)if(i.heal>=e*.5){a=i;break}a||(a=s[s.length-1])}this.useItemInBattle(a.id)}learnScroll(e){const t=this.game.inventory.items[e];if(!t)return;const s=this.game.config.items.scrolls.find(i=>i.id===t.id);if(!s||!s.skill||this.game.player.learnedSkills.includes(s.skill))return;this.game.player.learnedSkills.push(s.skill),this.removeItem(t.id,1);const a=this.game.config.skills.find(i=>i.id===s.skill);this.game.ui.log(`âœ¨ å­¦ä¼šæ–°æŠ€èƒ½ï¼š${a.icon} ${a.name}ï¼`),this.game.save(),this.game.ui.renderInventoryPanel()}getUnlockCost(){const e=this.game.inventory.slots-this.game.config.inventory.initialSlots;return Math.floor(this.game.config.inventory.unlockCostBase*Math.pow(this.game.config.inventory.unlockCostMultiplier,e))}unlockSlot(){if(this.game.inventory.slots>=this.game.config.inventory.maxSlots)return;const e=this.getUnlockCost();if(this.game.player.gold<e){this.game.ui.log("âŒ é‡‘å¸ä¸è¶³ï¼");return}this.game.player.gold-=e,this.game.inventory.slots++,this.game.ui.log(`ğŸ”“ èƒŒåŒ…æ‰©å……è‡³ ${this.game.inventory.slots} æ ¼ï¼`),this.game.save(),this.game.ui.render(),this.game.ui.renderInventoryPanel()}canForge(e){return Object.entries(e.materials).every(([t,s])=>this.getItemCount(t)>=s)}forgeItem(e,t){const s=this.game.config.equipment[e].find(a=>a.id===t);if(s&&this.canForge(s)){if(Object.entries(s.materials).forEach(([a,i])=>{this.removeItem(a,i)}),e==="weapons")this.game.player.weapon=t;else{this.game.player.armor=t;const a=s;a.maxShield&&a.maxShield>0&&(this.game.player.maxShield=this.game.playerManager.getTotalMaxShield(),this.game.player.shield=this.game.player.maxShield)}this.game.ui.log(`ğŸ”¨ é”»é€ æˆåŠŸï¼š${s.icon} ${s.name}ï¼`),this.game.save(),this.game.ui.render(),this.game.ui.showForgeCategory(e)}}}class C{game;seenLore;seenNPCs;triggeredEvents;constructor(e){this.game=e,this.seenLore=new Set,this.seenNPCs=new Set,this.triggeredEvents=new Set}getWorldLore(e){const t=this.game.config.worldLore;for(const s of t)if(e>=s.floorRange[0]&&e<=s.floorRange[1])return s;return t[0]}onFloorAdvance(e,t){const s=this.getWorldLore(e),a=`floor_${e}`;return this.seenLore.has(a)?null:(this.seenLore.add(a),{type:"lore",data:s,floor:e})}checkNPC(e){const s=this.game.config.npcs.filter(a=>e>=a.minFloor&&!this.seenNPCs.has(`${a.id}_${e}`));for(const a of s)if(Math.random()<a.probability)return this.seenNPCs.add(`${a.id}_${e}`),{type:"npc",data:a};return null}checkRandomEvent(e){const s=this.game.config.randomEvents.filter(a=>e>=a.minFloor);for(const a of s){const i=`${a.id}_${Date.now()}`;if(Math.random()<a.probability)return this.triggeredEvents.add(i),{type:"event",data:a}}return null}processEventReward(e){const t=e.reward,s=e.outcomes,a=e.effect,i={gold:0,exp:0,items:[],heal:0,lore:null};if(t&&(t.gold&&(i.gold=t.gold),t.exp&&(i.exp=t.exp),t.itemId&&i.items.push({itemId:t.itemId,count:1})),s&&s.length>0){const o=s.reduce((r,m)=>r+m.weight,0);let l=Math.random()*o;for(const r of s)if(l-=r.weight,l<=0){r.gold&&(i.gold=r.gold),r.itemId&&i.items.push({itemId:r.itemId,count:1});break}}if(a&&a.length>0){const o=a.reduce((r,m)=>r+m.weight,0);let l=Math.random()*o;for(const r of a)if(l-=r.weight,l<=0){r.type==="heal"&&(i.heal=r.value),r.type==="gold"&&(i.gold=r.value),r.type==="exp"&&(i.exp=r.value);break}}return e.lore&&(Array.isArray(e.lore)?i.lore=e.lore[Math.floor(Math.random()*e.lore.length)]:i.lore=e.lore),i}processNPCReward(e){const t=e.reward,s={gold:0,exp:0,items:[],heal:0,lore:null};return t&&(t.gold&&(s.gold=t.gold),t.exp&&(s.exp=t.exp),t.itemId&&s.items.push({itemId:t.itemId,count:1})),s}applyReward(e){if(e.gold&&e.gold>0&&(this.game.player.gold+=e.gold),e.exp&&e.exp>0&&(this.game.player.exp+=e.exp,this.game.playerManager.levelUp()),e.items&&e.items.length>0&&e.items.forEach(t=>{this.game.inventoryManager.addItem(t.itemId,t.count)}),e.heal&&e.heal>0){const t=Math.min(e.heal,this.game.player.maxHP-this.game.player.hp);this.game.player.hp+=t}}getNPCDialogue(e){return e.dialogues&&e.dialogues.length>0?e.dialogues[Math.floor(Math.random()*e.dialogues.length)]:e.greeting}hasStoryContent(){return this.seenLore.size>0}hasWorldLore(){return!0}hasNPCInteraction(){return this.seenNPCs.size>0}reset(){this.seenLore.clear(),this.seenNPCs.clear(),this.triggeredEvents.clear()}save(){return{seenLore:Array.from(this.seenLore),seenNPCs:Array.from(this.seenNPCs),triggeredEvents:Array.from(this.triggeredEvents)}}load(e){e&&(this.seenLore=new Set(e.seenLore||[]),this.seenNPCs=new Set(e.seenNPCs||[]))}}class w{game;constructor(e){this.game=e}isBossFloor(e){return this.game.config.bossFloors?.includes(e)??!1}getBossForFloor(e){const t=this.game.config.bosses?.find(s=>s.floor===e);return t?{id:t.id,name:t.name,avatar:t.avatar,hp:t.hp,maxHP:t.hp,atk:t.atk,def:t.def,exp:t.exp,gold:t.gold,critRate:t.critRate,dodgeRate:t.dodgeRate}:null}getPreviousBoss(e){const s=(this.game.config.bossFloors||[]).filter(a=>a<e).pop();return s?this.getBossForFloor(s):null}createMonster(){if(this.isBossFloor(this.game.floor)){const r=this.getBossForFloor(this.game.floor);if(r)return this.game.ui.log("âš ï¸ BOSS å…³å¡ï¼"),r}const e=this.game.config.floor,t=this.game.config.monsters.filter(r=>r.minFloor<=this.game.floor),s=Math.floor(Math.random()*t.length),a=t[s];let i=1+(this.game.floor-1)*e.difficultyMultiplier;const l=(this.game.config.bossFloors||[]).filter(r=>r<this.game.floor).pop();if(l){const r=l+1;if(this.game.floor===r){const m=this.getBossForFloor(l);if(m){const c=m.maxHP*.8,h=m.atk*.8,g=m.def*.8;i=Math.max(i,c/a.hp,h/a.atk,g/a.def)}}}return{id:a.id,name:a.name,avatar:a.avatar,hp:Math.floor(a.hp*i),maxHP:Math.floor(a.hp*i),atk:Math.floor(a.atk*i),def:Math.floor(a.def*i),exp:Math.floor(a.exp*i),gold:Math.floor(a.gold*i),critRate:a.critRate??.1,dodgeRate:a.dodgeRate??.05}}explore(){this.game.inBattle||(this.game.monster=this.createMonster(),this.game.inBattle=!0,this.game.slowEffect=0,this.game.ui.log(`é­é‡äº† ${this.game.monster.avatar} ${this.game.monster.name}ï¼`),this.game.ui.setButtons({attack:!1,skill:!1,item:!1,inventory:!1,next:!0}),this.game.ui.renderMonster())}calcDamage(e,t,s){return Math.max(1,Math.floor(e-t+Math.random()*s))}attack(){if(!this.game.inBattle)return;const e=this.calcDamage(this.game.playerManager.getTotalAtk(),this.game.monster.def,this.game.config.battle.normalAttackRand);this.dealDamage(e,`å¯¹ ${this.game.monster.name} é€ æˆ `)}useSkill(e){if(!this.game.inBattle)return;const t=this.game.config.skills.find(s=>s.id===e);if(t){if(this.game.player.skillCooldowns[e]>0){this.game.ui.log(`â³ ${t.name} å†·å´ä¸­ï¼è¿˜éœ€ ${this.game.player.skillCooldowns[e]} æ¬¡æ”»å‡»`);return}if(this.game.player.skillCooldowns[e]=t.cd,this.game.ui.updateSkillName(),this.game.ui.showSkillEffect(t),t.type==="attack"){const s=this.calcDamage(this.game.playerManager.getTotalAtk()*(t.damageMultiplier??1),this.game.monster.def,t.damageRand??0),a=`${t.icon} ${t.name}ï¼å¯¹ ${this.game.monster.name} é€ æˆ `;this.dealDamage(s,a,t)}else if(t.type==="heal"){const s=Math.floor(this.game.player.maxHP*(t.healPercent??0));this.game.player.hp=Math.min(this.game.player.hp+s,this.game.player.maxHP),this.game.ui.log(`${t.icon} ${t.name}ï¼æ¢å¤ <span class="heal">${s}</span> HP`),this.game.ui.showDamagePopup(s,!0),this.game.player.attackCount=(this.game.player.attackCount||0)+1,this.updateSkillCooldowns(),this.game.ui.updateSlotStates(),this.game.ui.render(),this.enemyAttack()}}}updateSkillCooldowns(){Object.keys(this.game.player.skillCooldowns).forEach(e=>{const t=this.game.player.skillCooldowns[e];t>0&&(this.game.player.skillCooldowns[e]=t-1)})}useSelectedSkill(){const e=this.game.player.selectedSkill||this.game.player.learnedSkills[0];if(!e){this.game.ui.log("âŒ æ²¡æœ‰å­¦ä¼šæŠ€èƒ½ï¼");return}const t=this.game.player.skillCooldowns[e]||0;if(t>0){const s=this.game.config.skills.find(a=>a.id===e);this.game.ui.log(`â³ ${s.name} å†·å´ä¸­ (${t}å›åˆ)ï¼`);return}this.useSkill(e)}dealDamage(e,t,s=null){this.game.player.attackCount=(this.game.player.attackCount||0)+1,s||this.updateSkillCooldowns();const a=this.game.player.critRate??this.game.config.player.initial.critRate,i=this.game.monster.dodgeRate??.05;if(Math.random()<i){this.game.ui.log(`${this.game.monster.avatar} ${this.game.monster.name} é—ªé¿äº†æ”»å‡»ï¼`),this.game.ui.showDamagePopup(0,!1,!0),this.game.ui.flashSlot(s?"skill":"attack"),this.enemyAttack(),this.game.ui.updateSlotStates(),this.game.ui.render();return}const o=Math.random()<a;let l=e;o&&(l=Math.floor(e*1.5)),this.game.monster.hp-=l;const r=o?"ğŸ’¥ æš´å‡»ï¼":"";this.game.ui.log(`${t}<span class="damage">${l}</span> ä¼¤å®³ï¼${r}`),this.game.ui.flashSlot(s?"skill":"attack"),this.game.ui.showDamagePopup(l,!1,!1,o),this.game.ui.flash(".monster-card");const m=this.game.playerManager.getTotalComboRate();if(m>0&&Math.random()<m){const c=this.performCombo(l);c>0&&(this.game.monster.hp-=c,this.game.ui.log(`âš”ï¸ è¿å‡»ï¼é¢å¤– <span class="damage">${c}</span> ä¼¤å®³ï¼`),this.game.ui.showDamagePopup(c,!1,!1,!1,!0))}if(s&&s.slow&&(this.game.slowEffect=s.slow,this.game.ui.log("â„ï¸ æ€ªç‰©è¢«å‡é€Ÿï¼")),s&&s.lifesteal){const c=Math.floor(l*s.lifesteal);this.game.player.hp=Math.min(this.game.player.hp+c,this.game.player.maxHP),this.game.ui.log(`ğŸ©¸ å¸è¡€æ¢å¤ <span class="heal">${c}</span> HP`),this.game.ui.showDamagePopup(c,!0)}this.game.ui.renderMonster(),this.game.monster.hp<=0?this.defeat():this.enemyAttack(),this.game.ui.updateSlotStates(),this.game.ui.render()}performCombo(e){const t=this.game.playerManager.getTotalComboRate(),s=this.game.playerManager.getTotalComboDamage();let a=0,i=0;for(;Math.random()<t&&a<3;)a++,i+=Math.floor(e*s);return i}enemyAttack(){let e=this.game.monster.atk;this.game.slowEffect>0&&(e=Math.floor(e*(1-this.game.slowEffect)),this.game.slowEffect=Math.max(0,this.game.slowEffect-.1));const t=this.game.player.dodgeRate??this.game.config.player.initial.dodgeRate;if(Math.random()<t){this.game.ui.log(`ğŸ’« ä½ é—ªé¿äº† ${this.game.monster.name} çš„æ”»å‡»ï¼`);return}const s=this.game.monster.critRate??.1,a=Math.random()<s;let i=this.calcDamage(e,this.game.playerManager.getTotalDef(),this.game.config.battle.enemyAttackRand);a&&(i=Math.floor(i*1.5));const o=this.game.playerManager.getTotalBlockRate();let l=!1;if(o>0&&Math.random()<o){const m=this.game.playerManager.getTotalBlockReduction();i=Math.floor(i*(1-m)),l=!0}if(this.game.player.shield>0&&(this.game.player.shield>=i?(this.game.player.shield-=i,i=0,this.game.ui.log("ğŸ›¡ï¸ æŠ¤ç›¾å¸æ”¶äº†æ‰€æœ‰ä¼¤å®³ï¼")):(i-=this.game.player.shield,this.game.ui.log(`ğŸ›¡ï¸ æŠ¤ç›¾å¸æ”¶äº† ${this.game.player.shield} ä¼¤å®³ï¼`),this.game.player.shield=0)),i>0){this.game.player.hp-=i;const m=a?"ğŸ’¥ æš´å‡»ï¼":"",c=l?"ğŸ›¡ï¸ æ ¼æŒ¡ï¼":"";this.game.ui.log(`${this.game.monster.avatar} ${this.game.monster.name} å¯¹ä½ é€ æˆ <span class="damage">${i}</span> ä¼¤å®³ï¼${m}${c}`),this.game.ui.showPlayerDamagePopup(i,l)}this.game.ui.flash(".status-bar");const r=this.game.playerManager.getTotalCounterRate();if(r>0&&Math.random()<r&&this.game.monster.hp>0){const m=Math.floor(this.game.playerManager.getTotalAtk()*this.game.playerManager.getTotalCounterDamage());if(this.game.monster.hp-=m,this.game.ui.log(`âš”ï¸ åå‡»ï¼å¯¹ ${this.game.monster.name} é€ æˆ <span class="damage">${m}</span> ä¼¤å®³ï¼`),this.game.ui.showDamagePopup(m,!1,!1,!1),this.game.ui.renderMonster(),this.game.monster.hp<=0){this.defeat();return}}this.game.player.hp<=0&&this.game.gameOver()}defeat(){this.game.inBattle=!1,this.game.killed++,this.game.player.exp+=this.game.monster.exp,this.game.player.gold+=this.game.monster.gold,this.game.player.hp=this.game.player.maxHP;const e=this.game.playerManager.getTotalMaxShield();e>0&&(this.game.player.shield=e),this.game.player.attackCount=0,this.game.ui.log(`ğŸ‰ å‡»è´¥ ${this.game.monster.name}ï¼+<span class="exp">${this.game.monster.exp}</span> ç»éªŒ +<span class="gold">${this.game.monster.gold}</span> é‡‘å¸ ğŸ’š ç”Ÿå‘½æ¢å¤æ»¡`),this.game.inventoryManager.grantLoot(this.game.monster.id),this.game.playerManager.checkSkillUnlock(),this.game.playerManager.levelUp();const t=this.game.storyManager.checkRandomEvent(this.game.floor);if(t){const s=this.game.storyManager.processEventReward(t.data);this.game.storyManager.applyReward(s),setTimeout(()=>{this.game.ui.showEventModal(t.data,s)},500)}this.game.save(),this.game.ui.updatePostBattleUI(),this.isBossFloor(this.game.floor)?(this.game.canAdvanceFloor=!0,this.game.nextFloor()):this.game.handleAutoNext()}}class ${game;constructor(e){this.game=e}log(e){const t=n("battleLog");if(!t)return;const s=document.createElement("p");s.innerHTML=e,t.appendChild(s),t.scrollTop=t.scrollHeight;const a=t.firstChild;t.children.length>15&&a&&t.removeChild(a)}flash(e){const t=document.querySelector(e);t&&(t.classList.add("shake"),setTimeout(()=>t.classList.remove("shake"),300))}flashSlot(e){const s=n({attack:"attackSlot",skill:"skillSlot",item:"itemSlot"}[e]);s&&(s.classList.add("active"),setTimeout(()=>s.classList.remove("active"),200))}updateSpeedDisplay(){const e=n("speedText");e&&(e.textContent=`${this.game.gameSpeed}X`)}updateFloorSelectText(){const e=n("floorSelectText");e&&(e.textContent=`ç¬¬${this.game.floor}å±‚`)}openFloorSelect(){const e=n("floorList"),t=n("floorSelectModal");if(!e||!t)return;let s="";for(let a=1;a<=this.game.maxFloorReached;a++){const i=this.game.battle.isBossFloor(a),o=a===this.game.floor,l=["floor-item"];i&&l.push("boss"),o&&l.push("current"),s+=`<div class="${l.join(" ")}" data-floor="${a}">
        <span class="num">${a}</span>
        <span class="icon">${i?"ğŸ‘‘":""}</span>
      </div>`}e.innerHTML=s,e.querySelectorAll(".floor-item").forEach(a=>{a.addEventListener("click",()=>{const i=parseInt(a.getAttribute("data-floor")||"1");this.game.goToFloor(i),t.classList.remove("show")})}),t.classList.add("show")}showSkillEffect(e){const t=n("skillEffectOverlay");if(!t)return;t.setAttribute("data-icon",e.icon),t.className="skill-effect-overlay";const a={powerStrike:"effect-power",fireball:"effect-fire",frostArrow:"effect-frost",thunderStrike:"effect-thunder",lifeSteal:"effect-power",heal:"effect-heal"}[e.id]||"effect-power";t.offsetWidth,t.classList.add("active",a),setTimeout(()=>{t.classList.remove("active",a)},600)}updateSlotStates(){const e=n("skillSlot"),t=n("itemSlot"),s=n("itemSlotCount"),a=n("skillCdOverlay"),i=n("skillCdProgress"),o=n("skillCdText"),l=this.game.player.selectedSkill||"powerStrike",r=this.game.player.skillCooldowns[l]??0,c=this.game.config.skills.find(g=>g.id===l)?.cd||3;if(e)if(r>0){if(a){if(a.classList.add("visible"),i){const g=r/c,p=100.53;i.style.strokeDashoffset=String(p*g)}o&&(o.textContent=String(r))}}else a&&a.classList.remove("visible");const h=this.game.inventory.items.filter(g=>g.id==="healthPotion").length;s&&(s.textContent=String(h)),t&&(h===0?t.classList.add("disabled"):t.classList.remove("disabled"))}showDamagePopup(e,t,s=!1,a=!1,i=!1,o=!1){const l=document.createElement("div");let r="damage-popup";if(t&&(r+=" heal-popup"),s&&(r+=" dodge-popup"),a&&(r+=" critical-popup"),i&&(r+=" combo-popup"),o&&(r+=" block-popup"),l.className=r,s)l.textContent="MISS";else if(o)l.textContent="ğŸ›¡ï¸";else{let c=t?"+":"-",h="";a&&(h="!"),i&&(h+="âš¡"),l.textContent=c+e+h}const m=document.querySelector(".monster-card");if(m){const c=m.getBoundingClientRect();l.style.left=c.left+c.width/2-20+Math.random()*40+"px",l.style.top=c.top+c.height/3+"px"}document.body.appendChild(l),setTimeout(()=>l.remove(),800)}showPlayerDamagePopup(e,t=!1){const s=document.createElement("div");let a="damage-popup player-damage";t&&(a+=" block-popup"),s.className=a,t?s.textContent=`-${e}ğŸ›¡ï¸`:s.textContent=`-${e}`;const i=document.querySelector(".status-bar");if(i){const o=i.getBoundingClientRect();s.style.left=o.left+20+Math.random()*30+"px",s.style.top=o.top+o.height/2+"px"}document.body.appendChild(s),setTimeout(()=>s.remove(),800)}render(){const e=this.game.player,t=n("playerLevel"),s=n("playerHP"),a=n("playerMaxHP"),i=n("playerATK"),o=n("playerDEF"),l=n("playerEXP"),r=n("playerMaxEXP"),m=n("playerGold"),c=n("currentFloor"),h=n("hpFill"),g=n("expBar"),p=n("shieldFill"),f=n("playerShield");t&&(t.textContent=String(e.level)),s&&(s.textContent=String(e.hp)),a&&(a.textContent=String(e.maxHP)),i&&(i.textContent=String(this.game.playerManager.getTotalAtk())),o&&(o.textContent=String(this.game.playerManager.getTotalDef())),l&&(l.textContent=String(e.exp)),r&&(r.textContent=String(e.maxEXP)),m&&(m.textContent=String(this.game.player.gold)),c&&(c.textContent=String(this.game.floor));const y=n("bossIcon"),v=this.game.battle.isBossFloor(this.game.floor);y&&(y.style.display=v?"inline":"none"),this.updateFloorSelectText(),this.updateSpeedDisplay();const k=Math.max(0,e.hp/e.maxHP*100),M=Math.max(0,e.exp/e.maxEXP*100);h&&(h.style.width=`${k}%`),g&&(g.style.width=`${M}%`);const u=this.game.playerManager.getTotalMaxShield();if(p&&u>0){const S=Math.max(0,e.shield/u*100);p.style.width=`${S}%`,p.parentElement.style.display="block"}else p&&(p.parentElement.style.display="none");f&&(f.textContent=u>0?`${e.shield}/${u}`:""),this.renderSecondaryStats(),this.updateSlotStates(),this.renderKillProgress(),this.renderEquipment()}renderSecondaryStats(){const e=n("comboRate"),t=n("counterRate"),s=n("blockRate"),a=n("secondaryStats"),i=this.game.playerManager.getTotalComboRate(),o=this.game.playerManager.getTotalCounterRate(),l=this.game.playerManager.getTotalBlockRate();e&&(e.textContent=`${Math.round(i*100)}%`),t&&(t.textContent=`${Math.round(o*100)}%`),s&&(s.textContent=`${Math.round(l*100)}%`);const r=i>0||o>0||l>0;a&&(a.style.display=r?"flex":"none")}renderKillProgress(){const e=this.game.getMonstersToAdvance(),t=Math.min(this.game.killed,e),s=n("killProgress");if(!s)return;this.game.battle.isBossFloor(this.game.floor)?(s.textContent="",s.classList.remove("complete")):(s.textContent=`${t}/${e}`,this.game.killed>=e?s.classList.add("complete"):s.classList.remove("complete"))}renderEquipment(){const e=n("playerWeapon"),t=n("playerArmor");if(this.game.player.weapon){const s=this.game.config.equipment.weapons.find(a=>a.id===this.game.player.weapon);e&&(e.textContent=s?s.name:"æ— ")}else e&&(e.textContent="æ— ");if(this.game.player.armor){const s=this.game.config.equipment.armors.find(a=>a.id===this.game.player.armor);t&&(t.textContent=s?s.name:"æ— ")}else t&&(t.textContent="æ— ")}renderMonster(){if(!this.game.monster)return;const e=n("monsterAvatar"),t=n("monsterName"),s=n("monsterHP"),a=n("monsterMaxHP"),i=n("monsterHPFill"),o=document.querySelector(".monster-card"),l=this.game.battle.isBossFloor(this.game.floor);o&&(l?o.classList.add("boss-monster"):o.classList.remove("boss-monster")),e&&(e.textContent=this.game.monster.avatar),t&&(t.textContent=l?`ğŸ‘‘ ${this.game.monster.name}`:this.game.monster.name,l?t.classList.add("boss-name"):t.classList.remove("boss-name")),s&&(s.textContent=String(Math.max(0,this.game.monster.hp))),a&&(a.textContent=String(this.game.monster.maxHP)),i&&(i.style.width=`${Math.max(0,this.game.monster.hp/this.game.monster.maxHP*100)}%`,l?i.classList.add("boss-hp"):i.classList.remove("boss-hp"))}setButtons({attack:e,skill:t,item:s,next:a}){const i=n("btnAttack"),o=n("btnSkill"),l=n("btnItem"),r=n("btnNextFloor");if(i&&(i.disabled=e),o&&(o.disabled=t),l&&(l.disabled=s),r){const m=a&&!this.game.canAdvanceFloor;r.disabled=m,this.game.canAdvanceFloor&&!a?r.classList.add("can-advance"):r.classList.remove("can-advance")}}updatePostBattleUI(){this.game.canAdvanceFloor=this.game.killed>=this.game.getMonstersToAdvance(),this.setButtons({attack:!0,skill:!0,item:!0,inventory:!1,next:!this.game.canAdvanceFloor})}updateSkillName(){const e=this.game.player.selectedSkill||this.game.player.learnedSkills[0],t=n("btnSkill"),s=n("currentSkillName"),a=n("skillSlotLabel"),i=n("skillSlotIcon");if(e){const o=this.game.config.skills.find(l=>l.id===e);if(o){a&&(a.textContent=o.name),i&&(i.textContent=o.icon);const l=this.game.player.skillCooldowns[e]||0;t&&s&&(l>0?(s.textContent=`${o.name} (CD:${l})`,t.classList.add("on-cooldown")):(s.textContent=o.name,t.classList.remove("on-cooldown")));return}}a&&(a.textContent="æ— æŠ€èƒ½"),i&&(i.textContent="âœ¨"),t&&s&&(s.textContent="æ— æŠ€èƒ½",t.classList.remove("on-cooldown"))}showLevelUp(e,t){const s=n("newLevel"),a=n("levelUpHP"),i=n("levelUpATK"),o=n("levelUpDEF"),l=n("levelUpModal");s&&(s.textContent=String(e)),a&&(a.textContent=`+${t.hp}`),i&&(i.textContent=`+${t.atk}`),o&&(o.textContent=`+${t.def}`),l&&l.classList.add("show")}closeLevelUpModal(){const e=n("levelUpModal");e&&e.classList.remove("show")}openInventory(){this.renderInventoryPanel();const e=n("inventoryModal");e&&e.classList.add("show")}renderInventoryPanel(){const e=[...this.game.config.items.consumables,...this.game.config.items.materials,...this.game.config.items.scrolls];let t=`<div class="inventory-header">
      <span>ğŸ’ èƒŒåŒ… (${this.game.inventory.items.length}/${this.game.inventory.slots})</span>`;if(this.game.inventory.slots<this.game.config.inventory.maxSlots){const a=this.game.inventoryManager.getUnlockCost();t+=`<button class="btn-unlock" onclick="game.unlockSlot()">ğŸ”“ æ‰©å…… (${a}ğŸ’°)</button>`}t+='</div><div class="inventory-grid">',this.game.inventory.items.forEach((a,i)=>{const o=e.find(l=>l.id===a.id);o&&(t+=`<div class="inv-item" onclick="game.showItemDetail(${i})">
        <span class="inv-icon">${o.icon}</span>
        <span class="inv-name">${o.name}</span>
        <span class="inv-count">x${a.count}</span>
      </div>`)}),this.game.inventory.items.length===0&&(t+='<p class="empty-inv">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</p>'),t+="</div>";const s=n("inventoryContent");s&&(s.innerHTML=t)}showItemDetail(e){const t=this.game.inventory.items[e];if(!t)return;const a=[...this.game.config.items.consumables,...this.game.config.items.materials,...this.game.config.items.scrolls].find(m=>m.id===t.id);if(!a)return;let i=`<div class="item-detail">
      <h3>${a.icon} ${a.name} x${t.count}</h3>`;const o=a,l=a;if(o.heal)i+=`<p>æ¢å¤ ${o.heal} HP</p>`,!this.game.inBattle&&this.game.player.hp<this.game.player.maxHP?i+=`<button class="btn btn-use" onclick="game.useItem(${e})">ä½¿ç”¨</button>`:this.game.inBattle?i+='<p class="hint">æˆ˜æ–—ä¸­æ— æ³•ä½¿ç”¨</p>':i+='<p class="hint">ç”Ÿå‘½å·²æ»¡</p>';else if(l.skill){const m=this.game.config.skills.find(c=>c.id===l.skill);m&&this.game.player.learnedSkills.includes(l.skill)?i+=`<p class="hint">å·²å­¦ä¼š ${m.name}</p>`:m&&(i+=`<p>å­¦ä¹ æŠ€èƒ½ï¼š${m.icon} ${m.name}</p>`,i+=`<button class="btn btn-use" onclick="game.learnScroll(${e})">å­¦ä¹ </button>`)}else i+='<p class="hint">é”»é€ ææ–™</p>';i+="</div>";const r=n("inventoryContent");r&&(r.innerHTML=i)}openItemMenu(){if(!this.game.inBattle)return;const e=this.game.inventory.items.filter(i=>{const o=this.game.config.items.consumables.find(l=>l.id===i.id);return o&&o.heal});let t="";e.length===0?t='<p class="no-items">æ²¡æœ‰å¯ä½¿ç”¨çš„é“å…·</p>':(t='<div class="item-options">',e.forEach(i=>{const o=this.game.config.items.consumables.find(l=>l.id===i.id);o&&(t+=`<div class="item-option" onclick="game.useItemInBattle('${i.id}')">
            <span class="item-icon">${o.icon}</span>
            <span class="item-name">${o.name}</span>
            <span class="item-count">x${i.count}</span>
            <span class="item-effect">+${o.heal} HP</span>
          </div>`)}),t+="</div>");const s=n("itemList"),a=n("itemModal");s&&(s.innerHTML=t),a&&a.classList.add("show")}openSkillMenu(){const e=this.game.player.learnedSkills,t=this.game.player.selectedSkill||e[0];let s='<div class="skill-select-list">';e.forEach(o=>{const l=this.game.config.skills.find(c=>c.id===o);if(!l)return;const r=this.game.player.skillCooldowns[o]||0,m=o===t;s+=`<div class="skill-select-item ${m?"selected":""}">
        <span class="skill-info">${l.icon} ${l.name}${r>0?` (${r})`:""}</span>
        <button class="btn-small ${m?"btn-selected":""}" onclick="game.selectSkill('${o}')">${m?"å·²é€‰":"é€‰æ‹©"}</button>
      </div>`}),s+="</div>",e.length===0&&(s='<p style="color:#a0a0a0;text-align:center;">è¿˜æ²¡æœ‰å­¦ä¼šæŠ€èƒ½</p>');const a=n("skillMenuContent"),i=n("skillModal");a&&(a.innerHTML=s),i&&i.classList.add("show")}openSkillManage(){const e=n("skillModal");e&&e.classList.remove("show");const t=this.game.player.learnedSkills,s=this.game.player.equippedSkills,a=this.game.playerManager.getUnlockedSkillSlots();let i=`<p class="slot-info">å·²è§£é” ${a} ä¸ªæŠ€èƒ½æ§½</p>`;i+='<div class="skill-manage-grid">';for(let r=0;r<4;r++){const m=r<a,c=s[r],h=c?this.game.config.skills.find(g=>g.id===c):null;if(i+=`<div class="skill-slot ${m?"":"locked"}">`,m)h?(i+=`<span>${h.icon} ${h.name}</span>`,i+=`<button class="btn-small" onclick="game.unequipSkill(${r})">å¸ä¸‹</button>`):i+='<span class="empty">ç©ºæ§½ä½</span>';else{const g=this.game.config.player.skillSlots[r];i+=`<span class="locked">ğŸ”’ Lv${g}è§£é”</span>`}i+="</div>"}i+="</div>",i+='<h4 style="margin: 12px 0 8px; color: var(--accent);">å·²å­¦æŠ€èƒ½</h4><div class="learned-skills">',t.forEach(r=>{if(s.includes(r))return;const m=this.game.config.skills.find(c=>c.id===r);m&&(i+=`<div class="skill-item">
        <span>${m.icon} ${m.name}</span>
        <button class="btn-small" onclick="game.equipSkill('${r}')">è£…å¤‡</button>
      </div>`)}),i+="</div>";const o=n("skillManageContent"),l=n("skillManageModal");o&&(o.innerHTML=i),l&&l.classList.add("show")}openForge(){this.renderForgePanel();const e=n("forgeModal");e&&e.classList.add("show")}renderForgePanel(){let e='<div class="forge-tabs">';e+=`<button class="tab-btn active" onclick="game.showForgeCategory('weapons')">âš”ï¸ æ­¦å™¨</button>`,e+=`<button class="tab-btn" onclick="game.showForgeCategory('armors')">ğŸ›¡ï¸ ç”²èƒ„</button>`,e+="</div>",e+='<div id="forgeList"></div>';const t=n("forgeContent");t&&(t.innerHTML=e),this.showForgeCategory("weapons")}showForgeCategory(e){document.querySelectorAll(".forge-tabs .tab-btn").forEach((o,l)=>{o.classList.toggle("active",e==="weapons"&&l===0||e==="armors"&&l===1)});const t=this.game.config.equipment[e],s=e==="weapons"?this.game.player.weapon:this.game.player.armor;let a='<div class="forge-list">';t.forEach(o=>{const l=s===o.id,r=this.game.inventoryManager.canForge(o);a+=`<div class="forge-item ${l?"equipped":""}">`,a+=`<div class="forge-info">
        <span class="forge-icon">${o.icon}</span>
        <span class="forge-name">${o.name}</span>
        <span class="forge-stat">${e==="weapons"?`ATK+${o.atk}`:`DEF+${o.def}`}</span>
        ${l?'<span class="equipped-badge">å·²è£…å¤‡</span>':""}
      </div>`,a+='<div class="forge-mats">',Object.entries(o.materials).forEach(([m,c])=>{const h=this.game.config.items.materials.find(f=>f.id===m),g=this.game.inventoryManager.getItemCount(m),p=g>=c;a+=`<span class="mat ${p?"":"lack"}">${h?h.icon:"?"} ${g}/${c}</span>`}),a+="</div>",l?a+=`<button class="btn btn-unequip" onclick="game.unequipItem('${e}')">å¸ä¸‹</button>`:r?a+=`<button class="btn btn-forge" onclick="game.forgeItem('${e}', '${o.id}')">é”»é€ </button>`:a+='<button class="btn btn-forge disabled" disabled>ææ–™ä¸è¶³</button>',a+="</div>"}),a+="</div>";const i=n("forgeList");i&&(i.innerHTML=a)}showConfirm(e,t){const s=n("confirmMessage"),a=n("confirmBtn"),i=n("confirmModal");s&&(s.textContent=e),a&&(a.onclick=()=>{this.closeConfirm(),t()}),i&&i.classList.add("show")}closeConfirm(){const e=n("confirmModal");e&&e.classList.remove("show")}openSettings(){const e=n("settingsModal");e&&e.classList.add("show")}closeAllModals(){document.querySelectorAll(".modal").forEach(e=>e.classList.remove("show"))}updateBattleBackground(e){const t=this.game.storyManager.getWorldLore(e),s=document.querySelector(".battle-area");s&&t&&(s.className=`battle-area ${t.bgClass}`)}modalAutoCloseTimer=null;startModalAutoClose(e,t=1e4){this.clearModalAutoClose(),this.modalAutoCloseTimer=setTimeout(()=>{const s=n(e);s&&s.classList.remove("show")},t)}clearModalAutoClose(){this.modalAutoCloseTimer&&(clearTimeout(this.modalAutoCloseTimer),this.modalAutoCloseTimer=null)}showLoreModal(e,t){const s=n("loreIcon"),a=n("loreTitle"),i=n("loreDescription"),o=n("loreContent"),l=n("storyModal");s&&(s.textContent=e.icon),a&&(a.textContent=`${e.name} - ç¬¬${t}å±‚`),i&&(i.textContent=e.description),o&&(o.textContent=e.lore),l&&l.classList.add("show"),this.startModalAutoClose("storyModal")}closeStoryModal(){this.clearModalAutoClose();const e=n("storyModal");e&&e.classList.remove("show")}showNPCModal(e){const t=n("npcAvatar"),s=n("npcName"),a=n("npcGreeting"),i=n("npcDialogue"),o=n("npcActions"),l=n("npcModal");t&&(t.textContent=e.avatar),s&&(s.textContent=e.name),a&&(a.textContent=e.greeting);const r=this.game.storyManager.getNPCDialogue(e);i&&(i.textContent=r);let m="";e.shop&&e.shop.length>0&&(m='<div class="npc-shop">',e.shop.forEach(c=>{const h=this.game.config.items.consumables.find(g=>g.id===c.itemId)||this.game.config.items.scrolls.find(g=>g.id===c.itemId);if(h){const g=this.game.player.gold>=c.price;m+=`<div class="shop-item ${g?"":"disabled"}" onclick="${g?`game.buyNPCItem('${e.id}', '${c.itemId}')`:""}">
            <span>${h.icon} ${h.name}</span>
            <span>${c.price}ğŸ’°</span>
          </div>`}}),m+="</div>"),e.reward&&(m+=`<button class="btn btn-primary" onclick="game.acceptNPCReward('${e.id}')">æ¥å—å¸®åŠ©</button>`),m+='<button class="btn btn-secondary" onclick="game.closeNPCModal()">ç¦»å¼€</button>',o&&(o.innerHTML=m),l&&l.classList.add("show"),this.startModalAutoClose("npcModal")}closeNPCModal(){this.clearModalAutoClose();const e=n("npcModal");e&&e.classList.remove("show")}showEventModal(e,t){const s=n("eventIcon"),a=n("eventName"),i=n("eventDescription"),o=n("eventResult"),l=n("eventModal");s&&(s.textContent=e.icon),a&&(a.textContent=e.name),i&&(i.textContent=e.description);let r="";t.lore&&(r+=`<p class="event-lore">${t.lore}</p>`),t.gold>0&&(r+=`<p>ğŸ’° è·å¾— ${t.gold} é‡‘å¸</p>`),t.exp>0&&(r+=`<p>â­ è·å¾— ${t.exp} ç»éªŒ</p>`),t.heal>0&&(r+=`<p>ğŸ’š æ¢å¤ ${t.heal} ç”Ÿå‘½</p>`),t.items&&t.items.length>0&&t.items.forEach(m=>{const c=this.game.config.items.consumables.find(h=>h.id===m.itemId)||this.game.config.items.scrolls.find(h=>h.id===m.itemId);c&&(r+=`<p>ğŸ è·å¾— ${c.icon} ${c.name}</p>`)}),o&&(o.innerHTML=r),l&&l.classList.add("show"),this.startModalAutoClose("eventModal")}closeEventModal(){this.clearModalAutoClose();const e=n("eventModal");e&&e.classList.remove("show")}}class P{config;floor=1;killed=0;maxFloorReached=1;monster=null;inBattle=!1;slowEffect=0;canAdvanceFloor=!1;autoBattleEnabled=!0;autoAdvanceEnabled=!1;autoBattleTimer=null;potionStrategy="auto30";gameSpeed=1;player;inventory;ui;battle;playerManager;inventoryManager;storyManager;constructor(e){this.config=e,this.ui=new $(this),this.battle=new w(this),this.playerManager=new b(this),this.inventoryManager=new x(this),this.storyManager=new C(this)}init(){this.load(),this.bindEvents(),this.ui.updateSkillName(),this.ui.render(),this.startAutoBattle(),setTimeout(()=>this.explore(),300)}save(){const e={player:this.player,floor:this.floor,killed:this.killed,maxFloorReached:this.maxFloorReached,gameSpeed:this.gameSpeed,inventory:this.inventory,story:this.storyManager.save()};localStorage.setItem("loopingEveSave",JSON.stringify(e))}load(){const e=localStorage.getItem("loopingEveSave");if(e){const t=JSON.parse(e);this.player=t.player,this.floor=t.floor,this.killed=t.killed,this.maxFloorReached=t.maxFloorReached||this.floor,this.gameSpeed=t.gameSpeed||1,this.inventory=t.inventory||{slots:this.config.inventory.initialSlots,items:[]},this.playerManager.migrateOldData(),this.storyManager.load(t.story),this.canAdvanceFloor=this.killed>=this.getMonstersToAdvance()}else this.playerManager.init(),this.inventoryManager.init()}bindEvents(){const e=n("btnAttack"),t=n("btnSkill"),s=n("btnItem"),a=n("btnNextFloor"),i=n("btnSettings"),o=n("btnClear2"),l=n("potionStrategy"),r=n("floorSelectBtn"),m=n("speedBtn");e&&(e.onclick=()=>this.battle.attack()),t&&(t.onclick=()=>this.battle.useSelectedSkill()),s&&(s.onclick=()=>this.inventoryManager.smartUseItem()),a&&(a.onclick=()=>this.nextFloor()),i&&(i.onclick=()=>this.ui.openSettings()),r&&(r.onclick=()=>this.ui.openFloorSelect()),m&&(m.onclick=()=>this.cycleSpeed()),l&&(l.value=this.potionStrategy,l.onchange=()=>{this.potionStrategy=l.value}),o&&(o.onclick=()=>{const c=n("settingsModal");c&&c.classList.remove("show"),this.ui.showConfirm("ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼",()=>this.clearSave())})}clearSave(){localStorage.removeItem("loopingEveSave"),this.playerManager.init(),this.inventoryManager.init(),this.storyManager.reset(),this.floor=1,this.killed=0,this.monster=null,this.inBattle=!1,this.slowEffect=0,this.canAdvanceFloor=!1;const e=n("battleLog");e&&(e.innerHTML="<p>å­˜æ¡£å·²æ¸…é™¤ï¼Œç‚¹å‡»ã€Œæ¢ç´¢ã€å¼€å§‹ï¼</p>"),this.ui.setButtons({attack:!0,skill:!0,item:!0,inventory:!1,next:!0}),this.ui.updateBattleBackground(1),this.ui.render(),this.ui.closeAllModals()}nextFloor(e=!1){const t=this.floor;this.floor++,this.killed=0,this.maxFloorReached=Math.max(this.maxFloorReached,this.floor),this.ui.log(`ğŸ“ è¿›å…¥ç¬¬ ${this.floor} å±‚ï¼`);const s=n("btnNextFloor");if(s&&(s.disabled=!0),this.ui.updateBattleBackground(this.floor),!e){const a=this.storyManager.onFloorAdvance(this.floor,t);a&&this.ui.showLoreModal(a.data,this.floor);const i=this.storyManager.checkNPC(this.floor);i&&setTimeout(()=>{this.ui.showNPCModal(i.data)},a?2e3:500)}this.save(),this.ui.render()}getMonstersToAdvance(){const e=this.config.floor.monstersToAdvance,t=this.config.floor.maxMonsters||10,s=this.floor;return s<=5?e:s<=10?Math.min(e+1,t):s<=20?Math.min(e+2,t):Math.min(e+3,t)}handleAutoNext(){const t=n("autoNext")?.checked??!1;setTimeout(()=>{this.canAdvanceFloor&&t?(this.nextFloor(!0),setTimeout(()=>this.battle.explore(),300)):this.battle.explore()},500)}gameOver(){this.stopAutoBattle(),this.stopAutoAdvance(),this.floor=Math.max(1,this.floor-1),this.killed=0,this.player.hp=this.player.maxHP,this.player.shield=0,this.ui.log(`ğŸ’€ ä½ è¢«å‡»è´¥äº†ï¼å›é€€åˆ°ç¬¬ ${this.floor} å±‚...`),this.ui.updateBattleBackground(this.floor),this.canAdvanceFloor=!1,this.inBattle=!1,this.monster=null,this.save(),this.ui.render(),setTimeout(()=>{this.startAutoBattle(),this.battle.explore()},1e3)}restart(){this.playerManager.init(),this.inventoryManager.init(),this.storyManager.reset(),this.floor=1,this.killed=0,this.monster=null,this.inBattle=!1,this.slowEffect=0,localStorage.removeItem("loopingEveSave");const e=n("gameOverModal"),t=n("battleLog");e&&e.classList.remove("show"),t&&(t.innerHTML="<p>æ¸¸æˆå¼€å§‹ï¼</p>"),this.ui.setButtons({attack:!0,skill:!0,item:!0,inventory:!1,next:!0}),this.ui.updateBattleBackground(1),this.ui.render(),setTimeout(()=>this.explore(),500)}explore(){this.battle.explore()}attack(){this.battle.attack()}startAutoBattle(){this.autoBattleTimer||(this.autoBattleEnabled=!0,this.runAutoBattleLoop())}stopAutoBattle(){this.autoBattleEnabled=!1,this.autoBattleTimer&&(clearTimeout(this.autoBattleTimer),this.autoBattleTimer=null)}stopAutoAdvance(){this.autoAdvanceEnabled=!1;const e=document.getElementById("autoAdvance");e&&(e.checked=!1)}runAutoBattleLoop(){if(!this.autoBattleEnabled)return;const t=(this.config.battle.autoBattleInterval||1e3)/this.gameSpeed;this.autoBattleTimer=setTimeout(()=>{if(this.autoBattleEnabled){try{if(this.inBattle&&this.monster&&this.player){const s=this.player.selectedSkill||"powerStrike",a=this.player.skillCooldowns[s]??0;this.shouldAutoUsePotion()?(this.inventoryManager.smartUseItem(),this.ui.flashSlot("item")):a===0?this.battle.useSelectedSkill():this.battle.attack()}else this.inBattle||this.battle.explore()}catch(s){console.warn("Auto battle error:",s)}this.runAutoBattleLoop()}},t)}cycleSpeed(){const e=[1,2,3],t=e.indexOf(this.gameSpeed);this.gameSpeed=e[(t+1)%e.length],this.ui.updateSpeedDisplay()}goToFloor(e){e>this.maxFloorReached||e!==this.floor&&(this.floor=e,this.killed=0,this.monster=null,this.inBattle=!1,this.canAdvanceFloor=!1,this.save(),this.ui.render(),this.ui.updateFloorSelectText())}shouldAutoUsePotion(){return this.potionStrategy==="manual"||!this.inventory.items.some(t=>t.id==="healthPotion")?!1:this.potionStrategy==="auto30"?this.player.hp<this.player.maxHP*.3:this.potionStrategy==="auto50"?this.player.hp<this.player.maxHP*.5:this.potionStrategy==="battleStart"?this.player.hp<this.player.maxHP*.9:!1}useSkill(e){this.battle.useSkill(e)}useFirstSkill(){this.battle.useSelectedSkill()}useItem(e){this.inventoryManager.useItem(e)}useItemInBattle(e){this.inventoryManager.useItemInBattle(e)}smartUseItem(){this.inventoryManager.smartUseItem()}learnScroll(e){this.inventoryManager.learnScroll(e)}unlockSlot(){this.inventoryManager.unlockSlot()}openInventory(){this.ui.openInventory()}openItemMenu(){this.ui.openItemMenu()}openSkillMenu(){this.ui.openSkillMenu()}openSkillManage(){this.ui.openSkillManage()}openForge(){this.ui.openForge()}showForgeCategory(e){this.ui.showForgeCategory(e)}forgeItem(e,t){this.inventoryManager.forgeItem(e,t)}unequipItem(e){this.playerManager.unequipItem(e),this.save(),this.ui.render(),this.ui.showForgeCategory(e),this.ui.log("ğŸ“¤ å·²å¸ä¸‹è£…å¤‡")}equipSkill(e){const t=this.playerManager.equipSkill(e),s=this.config.skills.find(a=>a.id===e);t&&s&&this.ui.log(`âš ï¸ ${t} å·²è¢«æ›¿æ¢ä¸º ${s.name}`),this.save(),this.ui.updateSkillName(),this.ui.openSkillManage()}unequipSkill(e){this.playerManager.unequipSkill(e),this.save(),this.ui.updateSkillName(),this.ui.openSkillManage()}selectSkill(e){this.player.selectedSkill=e,this.save(),this.ui.updateSkillName(),this.ui.openSkillMenu()}closeLevelUpModal(){this.ui.closeLevelUpModal()}closeStoryModal(){this.ui.closeStoryModal()}closeNPCModal(){this.ui.closeNPCModal()}closeEventModal(){this.ui.closeEventModal()}buyNPCItem(e,t){const s=this.config.npcs.find(i=>i.id===e);if(!s||!s.shop)return;const a=s.shop.find(i=>i.itemId===t);if(a){if(this.player.gold<a.price){this.ui.log("ğŸ’° é‡‘å¸ä¸è¶³ï¼");return}this.player.gold-=a.price,this.inventoryManager.addItem(t,1),this.ui.log("ğŸ’° è´­ä¹°äº†ç‰©å“ï¼"),this.save(),this.ui.render()}}acceptNPCReward(e){const t=this.config.npcs.find(a=>a.id===e);if(!t)return;const s=this.storyManager.processNPCReward(t);this.storyManager.applyReward(s),this.ui.closeNPCModal(),s.gold>0&&this.ui.log(`ğŸ’° è·å¾— ${s.gold} é‡‘å¸`),s.exp>0&&this.ui.log(`â­ è·å¾— ${s.exp} ç»éªŒ`),s.items.length>0&&this.ui.log("ğŸ è·å¾—ç‰©å“"),this.save(),this.ui.render()}showConfirm(e,t){this.ui.showConfirm(e,t)}closeConfirm(){this.ui.closeConfirm()}showItemDetail(e){this.ui.showItemDetail(e)}}async function L(){const e=await fetch("./MainGame/dist/"+"Configs/config.json?t="+Date.now());if(!e.ok)throw new Error("é…ç½®åŠ è½½å¤±è´¥");return e.json()}function A(d){document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&(e.id==="gameOverModal"?d.restart():e.classList.remove("show"))})})}L().then(d=>{const e=new P(d);window.game=e,e.init(),A(e)}).catch(d=>{alert("é…ç½®åŠ è½½å¤±è´¥ï¼š"+d.message)});
//# sourceMappingURL=index.wDCBung2.js.map
