(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const o=d=>document.getElementById(d);class u{game;constructor(e){this.game=e}init(){this.game.player={...this.game.config.player.initial,weapon:null,armor:null,learnedSkills:["powerStrike"],equippedSkills:["powerStrike"],selectedSkill:"powerStrike",skillCooldowns:{}}}getTotalAtk(){let e=this.game.player.atk;if(this.game.player.weapon){const t=this.game.config.equipment.weapons.find(s=>s.id===this.game.player.weapon);t&&(e+=t.atk)}return e}getTotalDef(){let e=this.game.player.def;if(this.game.player.armor){const t=this.game.config.equipment.armors.find(s=>s.id===this.game.player.armor);t&&(e+=t.def)}return e}getUnlockedSkillSlots(){const e=this.game.player.level;return this.game.config.player.skillSlots.filter(t=>e>=t).length}levelUp(){const e=this.game.config.player.levelUp;for(;this.game.player.exp>=this.game.player.maxEXP;)this.game.player.exp-=this.game.player.maxEXP,this.game.player.level++,this.game.player.maxHP+=e.hp,this.game.player.hp=Math.min(this.game.player.hp+e.hp,this.game.player.maxHP),this.game.player.atk+=e.atk,this.game.player.def+=e.def,this.game.player.maxEXP=Math.floor(this.game.player.maxEXP*e.expMultiplier),this.game.ui.showLevelUp(this.game.player.level,e)}equipSkill(e){const t=this.game.player.equippedSkills;if(t.includes(e))return null;const s=this.getUnlockedSkillSlots();let i=null;if(t.length>=s&&t[0]){const a=this.game.config.skills.find(n=>n.id===t[0]);i=a?a.name:t[0],t.shift()}return t.push(e),i}unequipSkill(e){return e<0||e>=this.game.player.equippedSkills.length?!1:(this.game.player.equippedSkills.splice(e,1),!0)}checkSkillUnlock(){const e=this.game.player.level;this.game.config.skills.forEach(t=>{if(this.game.player.learnedSkills.includes(t.id)||t.unlock==="default"||t.unlock==="scroll")return;const s=t.unlock.match(/^level(\d+)$/);if(s&&e>=parseInt(s[1])&&(this.game.player.learnedSkills.push(t.id),this.game.ui.log(`âœ¨ å­¦ä¼šæ–°æŠ€èƒ½ï¼š${t.icon} ${t.name}ï¼`),!this.game.player.equippedSkills.includes(t.id))){const i=this.getUnlockedSkillSlots();this.game.player.equippedSkills.length<i&&this.game.player.equippedSkills.push(t.id)}})}reduceCooldowns(){Object.keys(this.game.player.skillCooldowns).forEach(e=>{this.game.player.skillCooldowns[e]>0&&this.game.player.skillCooldowns[e]--}),this.game.ui.updateSkillName()}migrateOldData(){this.game.player.learnedSkills||(this.game.player.learnedSkills=["powerStrike"],this.game.player.equippedSkills=["powerStrike"],this.game.player.skillCooldowns={}),this.game.player.selectedSkill||(this.game.player.selectedSkill=this.game.player.learnedSkills[0]||"powerStrike"),this.game.player.weapon||(this.game.player.weapon=null),this.game.player.armor||(this.game.player.armor=null)}unequipItem(e){e==="weapons"?this.game.player.weapon=null:this.game.player.armor=null}}class y{game;constructor(e){this.game=e}init(){this.game.inventory={slots:this.game.config.inventory.initialSlots,items:[]}}addItem(e,t=1){const i=[...this.game.config.items.consumables,...this.game.config.items.materials,...this.game.config.items.scrolls].find(n=>n.id===e);if(!i)return;const a=this.game.inventory.items.find(n=>n.id===e);if(a){const n=Math.min(a.count+t,i.stackMax),l=n-a.count;a.count=n,l>0&&this.game.ui.log(`ğŸ“¦ ${i.icon} ${i.name} +${l}`)}else{if(this.game.inventory.items.length>=this.game.inventory.slots){this.game.ui.log(`âš ï¸ èƒŒåŒ…å·²æ»¡ï¼Œ${i.name} ä¸¢å¤±ï¼`);return}this.game.inventory.items.push({id:e,count:Math.min(t,i.stackMax)}),this.game.ui.log(`ğŸ“¦ ${i.icon} ${i.name} +${t}`)}}removeItem(e,t=1){const s=this.game.inventory.items.findIndex(i=>i.id===e);return s===-1?!1:(this.game.inventory.items[s].count-=t,this.game.inventory.items[s].count<=0&&this.game.inventory.items.splice(s,1),!0)}getItemCount(e){const t=this.game.inventory.items.find(s=>s.id===e);return t?t.count:0}grantLoot(e){const t=this.game.config.lootTable[e];t&&t.forEach(s=>{if(Math.random()<s.rate){const i=Math.floor(Math.random()*(s.maxCount-s.minCount+1))+s.minCount;this.addItem(s.itemId,i)}})}useItem(e){const t=this.game.inventory.items[e];if(!t)return;const s=this.game.config.items.consumables.find(a=>a.id===t.id);if(!s||!s.heal)return;const i=Math.min(s.heal,this.game.player.maxHP-this.game.player.hp);i<=0||(this.game.player.hp+=i,this.removeItem(t.id,1),this.game.ui.log(`ğŸ’š ä½¿ç”¨ ${s.name}ï¼Œæ¢å¤ <span class="heal">${i}</span> HP`),this.game.save(),this.game.ui.render(),this.game.ui.renderInventoryPanel())}useItemInBattle(e){if(!this.game.inBattle)return;const t=this.game.config.items.consumables.find(i=>i.id===e);if(!t||!t.heal)return;const s=Math.min(t.heal,this.game.player.maxHP-this.game.player.hp);this.game.player.hp+=s,this.removeItem(e,1),this.game.ui.log(`ğŸ’š ä½¿ç”¨ ${t.name}ï¼Œæ¢å¤ <span class="heal">${s}</span> HP`),this.game.ui.showDamagePopup(s,!0),document.getElementById("itemModal")?.classList.remove("show"),this.game.save(),this.game.ui.render(),this.game.battle.enemyAttack()}smartUseItem(){if(!this.game.inBattle){this.game.ui.log("âŒ éæˆ˜æ–—çŠ¶æ€ï¼");return}const e=this.game.player.maxHP-this.game.player.hp;if(e<2){this.game.ui.log("ğŸ’š æ— éœ€æ¢å¤è¡€é‡ï¼");return}const t=this.game.player.hp/this.game.player.maxHP,s=this.game.inventory.items.filter(a=>{const n=this.game.config.items.consumables.find(l=>l.id===a.id);return n&&n.heal}).map(a=>{const n=this.game.config.items.consumables.find(l=>l.id===a.id);return{...a,def:n,heal:n.heal}}).sort((a,n)=>n.heal-a.heal);if(s.length===0){this.game.ui.log("âŒ æ²¡æœ‰å¯ç”¨çš„é“å…·ï¼");return}let i=null;if(t<.3)i=s[0];else{for(const a of s)if(a.heal>=e*.5){i=a;break}i||(i=s[s.length-1])}this.useItemInBattle(i.id)}learnScroll(e){const t=this.game.inventory.items[e];if(!t)return;const s=this.game.config.items.scrolls.find(a=>a.id===t.id);if(!s||!s.skill||this.game.player.learnedSkills.includes(s.skill))return;this.game.player.learnedSkills.push(s.skill),this.removeItem(t.id,1);const i=this.game.config.skills.find(a=>a.id===s.skill);this.game.ui.log(`âœ¨ å­¦ä¼šæ–°æŠ€èƒ½ï¼š${i.icon} ${i.name}ï¼`),this.game.save(),this.game.ui.renderInventoryPanel()}getUnlockCost(){const e=this.game.inventory.slots-this.game.config.inventory.initialSlots;return Math.floor(this.game.config.inventory.unlockCostBase*Math.pow(this.game.config.inventory.unlockCostMultiplier,e))}unlockSlot(){if(this.game.inventory.slots>=this.game.config.inventory.maxSlots)return;const e=this.getUnlockCost();if(this.game.player.gold<e){this.game.ui.log("âŒ é‡‘å¸ä¸è¶³ï¼");return}this.game.player.gold-=e,this.game.inventory.slots++,this.game.ui.log(`ğŸ”“ èƒŒåŒ…æ‰©å……è‡³ ${this.game.inventory.slots} æ ¼ï¼`),this.game.save(),this.game.ui.render(),this.game.ui.renderInventoryPanel()}canForge(e){return Object.entries(e.materials).every(([t,s])=>this.getItemCount(t)>=s)}forgeItem(e,t){const s=this.game.config.equipment[e].find(i=>i.id===t);s&&this.canForge(s)&&(Object.entries(s.materials).forEach(([i,a])=>{this.removeItem(i,a)}),e==="weapons"?this.game.player.weapon=t:this.game.player.armor=t,this.game.ui.log(`ğŸ”¨ é”»é€ æˆåŠŸï¼š${s.icon} ${s.name}ï¼`),this.game.save(),this.game.ui.render(),this.game.ui.showForgeCategory(e))}}class v{game;seenLore;seenNPCs;triggeredEvents;constructor(e){this.game=e,this.seenLore=new Set,this.seenNPCs=new Set,this.triggeredEvents=new Set}getWorldLore(e){const t=this.game.config.worldLore;for(const s of t)if(e>=s.floorRange[0]&&e<=s.floorRange[1])return s;return t[0]}onFloorAdvance(e,t){const s=this.getWorldLore(e),i=`floor_${e}`;return this.seenLore.has(i)?null:(this.seenLore.add(i),{type:"lore",data:s,floor:e})}checkNPC(e){const s=this.game.config.npcs.filter(i=>e>=i.minFloor&&!this.seenNPCs.has(`${i.id}_${e}`));for(const i of s)if(Math.random()<i.probability)return this.seenNPCs.add(`${i.id}_${e}`),{type:"npc",data:i};return null}checkRandomEvent(e){const s=this.game.config.randomEvents.filter(i=>e>=i.minFloor);for(const i of s){const a=`${i.id}_${Date.now()}`;if(Math.random()<i.probability)return this.triggeredEvents.add(a),{type:"event",data:i}}return null}processEventReward(e){const t=e.reward,s=e.outcomes,i=e.effect,a={gold:0,exp:0,items:[],heal:0,lore:null};if(t&&(t.gold&&(a.gold=t.gold),t.exp&&(a.exp=t.exp),t.itemId&&a.items.push({itemId:t.itemId,count:1})),s&&s.length>0){const n=s.reduce((r,c)=>r+c.weight,0);let l=Math.random()*n;for(const r of s)if(l-=r.weight,l<=0){r.gold&&(a.gold=r.gold),r.itemId&&a.items.push({itemId:r.itemId,count:1});break}}if(i&&i.length>0){const n=i.reduce((r,c)=>r+c.weight,0);let l=Math.random()*n;for(const r of i)if(l-=r.weight,l<=0){r.type==="heal"&&(a.heal=r.value),r.type==="gold"&&(a.gold=r.value),r.type==="exp"&&(a.exp=r.value);break}}return e.lore&&(Array.isArray(e.lore)?a.lore=e.lore[Math.floor(Math.random()*e.lore.length)]:a.lore=e.lore),a}processNPCReward(e){const t=e.reward,s={gold:0,exp:0,items:[],heal:0,lore:null};return t&&(t.gold&&(s.gold=t.gold),t.exp&&(s.exp=t.exp),t.itemId&&s.items.push({itemId:t.itemId,count:1})),s}applyReward(e){if(e.gold&&e.gold>0&&(this.game.player.gold+=e.gold),e.exp&&e.exp>0&&(this.game.player.exp+=e.exp,this.game.playerManager.levelUp()),e.items&&e.items.length>0&&e.items.forEach(t=>{this.game.inventoryManager.addItem(t.itemId,t.count)}),e.heal&&e.heal>0){const t=Math.min(e.heal,this.game.player.maxHP-this.game.player.hp);this.game.player.hp+=t}}getNPCDialogue(e){return e.dialogues&&e.dialogues.length>0?e.dialogues[Math.floor(Math.random()*e.dialogues.length)]:e.greeting}hasStoryContent(){return this.seenLore.size>0}hasWorldLore(){return!0}hasNPCInteraction(){return this.seenNPCs.size>0}reset(){this.seenLore.clear(),this.seenNPCs.clear(),this.triggeredEvents.clear()}save(){return{seenLore:Array.from(this.seenLore),seenNPCs:Array.from(this.seenNPCs),triggeredEvents:Array.from(this.triggeredEvents)}}load(e){e&&(this.seenLore=new Set(e.seenLore||[]),this.seenNPCs=new Set(e.seenNPCs||[]))}}class k{game;constructor(e){this.game=e}createMonster(){const e=this.game.config.floor,t=this.game.config.monsters.filter(n=>n.minFloor<=this.game.floor),s=Math.floor(Math.random()*t.length),i=t[s],a=1+(this.game.floor-1)*e.difficultyMultiplier;return{id:i.id,name:i.name,avatar:i.avatar,hp:Math.floor(i.hp*a),maxHP:Math.floor(i.hp*a),atk:Math.floor(i.atk*a),def:Math.floor(i.def*a),exp:Math.floor(i.exp*a),gold:Math.floor(i.gold*a),critRate:i.critRate??.1,dodgeRate:i.dodgeRate??.05}}explore(){this.game.inBattle||(this.game.monster=this.createMonster(),this.game.inBattle=!0,this.game.slowEffect=0,this.game.ui.log(`é­é‡äº† ${this.game.monster.avatar} ${this.game.monster.name}ï¼`),this.game.ui.setButtons({attack:!1,skill:!1,item:!1,inventory:!1,next:!0}),this.game.ui.renderMonster())}calcDamage(e,t,s){return Math.max(1,Math.floor(e-t+Math.random()*s))}attack(){if(!this.game.inBattle)return;const e=this.calcDamage(this.game.playerManager.getTotalAtk(),this.game.monster.def,this.game.config.battle.normalAttackRand);this.dealDamage(e,`å¯¹ ${this.game.monster.name} é€ æˆ `)}useSkill(e){if(!this.game.inBattle)return;const t=this.game.config.skills.find(s=>s.id===e);if(t){if(this.game.player.skillCooldowns[e]>0){this.game.ui.log(`â³ ${t.name} å†·å´ä¸­ï¼`);return}if(this.game.player.skillCooldowns[e]=t.cd,this.game.ui.updateSkillName(),t.type==="attack"){const s=this.calcDamage(this.game.playerManager.getTotalAtk()*(t.damageMultiplier??1),this.game.monster.def,t.damageRand??0),i=`${t.icon} ${t.name}ï¼å¯¹ ${this.game.monster.name} é€ æˆ `;this.dealDamage(s,i,t)}else if(t.type==="heal"){const s=Math.floor(this.game.player.maxHP*(t.healPercent??0));this.game.player.hp=Math.min(this.game.player.hp+s,this.game.player.maxHP),this.game.ui.log(`${t.icon} ${t.name}ï¼æ¢å¤ <span class="heal">${s}</span> HP`),this.game.ui.showDamagePopup(s,!0),this.game.ui.render(),this.enemyAttack()}}}useSelectedSkill(){const e=this.game.player.selectedSkill||this.game.player.learnedSkills[0];if(!e){this.game.ui.log("âŒ æ²¡æœ‰å­¦ä¼šæŠ€èƒ½ï¼");return}const t=this.game.player.skillCooldowns[e]||0;if(t>0){const s=this.game.config.skills.find(i=>i.id===e);this.game.ui.log(`â³ ${s.name} å†·å´ä¸­ (${t}å›åˆ)ï¼`);return}this.useSkill(e)}dealDamage(e,t,s=null){const i=this.game.player.critRate??this.game.config.player.initial.critRate,a=this.game.monster.dodgeRate??.05;if(Math.random()<a){this.game.ui.log(`${this.game.monster.avatar} ${this.game.monster.name} é—ªé¿äº†æ”»å‡»ï¼`),this.game.ui.showDamagePopup(0,!1,!0),this.enemyAttack(),this.game.ui.render();return}const n=Math.random()<i;let l=e;n&&(l=Math.floor(e*1.5)),this.game.monster.hp-=l;const r=n?"ğŸ’¥ æš´å‡»ï¼":"";if(this.game.ui.log(`${t}<span class="damage">${l}</span> ä¼¤å®³ï¼${r}`),this.game.ui.showDamagePopup(l,!1,!1,n),this.game.ui.flash(".monster-card"),s&&s.slow&&(this.game.slowEffect=s.slow,this.game.ui.log("â„ï¸ æ€ªç‰©è¢«å‡é€Ÿï¼")),s&&s.lifesteal){const c=Math.floor(l*s.lifesteal);this.game.player.hp=Math.min(this.game.player.hp+c,this.game.player.maxHP),this.game.ui.log(`ğŸ©¸ å¸è¡€æ¢å¤ <span class="heal">${c}</span> HP`),this.game.ui.showDamagePopup(c,!0)}this.game.ui.renderMonster(),this.game.monster.hp<=0?this.defeat():this.enemyAttack(),this.game.ui.render()}enemyAttack(){let e=this.game.monster.atk;this.game.slowEffect>0&&(e=Math.floor(e*(1-this.game.slowEffect)),this.game.slowEffect=Math.max(0,this.game.slowEffect-.1));const t=this.game.player.dodgeRate??this.game.config.player.initial.dodgeRate;if(Math.random()<t){this.game.ui.log(`ğŸ’« ä½ é—ªé¿äº† ${this.game.monster.name} çš„æ”»å‡»ï¼`);return}const s=this.game.monster.critRate??.1,i=Math.random()<s;let a=this.calcDamage(e,this.game.playerManager.getTotalDef(),this.game.config.battle.enemyAttackRand);i&&(a=Math.floor(a*1.5)),this.game.player.hp-=a;const n=i?"ğŸ’¥ æš´å‡»ï¼":"";this.game.ui.log(`${this.game.monster.avatar} ${this.game.monster.name} å¯¹ä½ é€ æˆ <span class="damage">${a}</span> ä¼¤å®³ï¼${n}`),this.game.ui.flash(".status-bar"),this.game.player.hp<=0&&this.game.gameOver()}defeat(){this.game.inBattle=!1,this.game.killed++,this.game.player.exp+=this.game.monster.exp,this.game.player.gold+=this.game.monster.gold,this.game.ui.log(`ğŸ‰ å‡»è´¥ ${this.game.monster.name}ï¼+<span class="exp">${this.game.monster.exp}</span> ç»éªŒ +<span class="gold">${this.game.monster.gold}</span> é‡‘å¸`),this.game.inventoryManager.grantLoot(this.game.monster.id),this.game.playerManager.reduceCooldowns(),this.game.playerManager.checkSkillUnlock(),this.game.playerManager.levelUp();const e=this.game.storyManager.checkRandomEvent(this.game.floor);if(e){const t=this.game.storyManager.processEventReward(e.data);this.game.storyManager.applyReward(t),setTimeout(()=>{this.game.ui.showEventModal(e.data,t)},500)}this.game.save(),this.game.ui.updatePostBattleUI(),this.game.handleAutoNext()}}class M{game;constructor(e){this.game=e}log(e){const t=o("battleLog");if(!t)return;const s=document.createElement("p");s.innerHTML=e,t.appendChild(s),t.scrollTop=t.scrollHeight;const i=t.firstChild;t.children.length>15&&i&&t.removeChild(i)}flash(e){const t=document.querySelector(e);t&&(t.classList.add("shake"),setTimeout(()=>t.classList.remove("shake"),300))}showDamagePopup(e,t,s=!1,i=!1){const a=document.createElement("div");let n="damage-popup";t&&(n+=" heal-popup"),s&&(n+=" dodge-popup"),i&&(n+=" critical-popup"),a.className=n,s?a.textContent="MISS":a.textContent=(t?"+":"-")+e+(i?"!":"");const l=document.querySelector(".monster-card");if(l){const r=l.getBoundingClientRect();a.style.left=r.left+r.width/2-20+Math.random()*40+"px",a.style.top=r.top+r.height/3+"px"}document.body.appendChild(a),setTimeout(()=>a.remove(),800)}render(){const e=this.game.player,t=o("playerLevel"),s=o("playerHP"),i=o("playerMaxHP"),a=o("playerATK"),n=o("playerDEF"),l=o("playerEXP"),r=o("playerMaxEXP"),c=o("playerGold"),m=o("currentFloor"),h=o("hpFill"),g=o("expBar");t&&(t.textContent=String(e.level)),s&&(s.textContent=String(e.hp)),i&&(i.textContent=String(e.maxHP)),a&&(a.textContent=String(this.game.playerManager.getTotalAtk())),n&&(n.textContent=String(this.game.playerManager.getTotalDef())),l&&(l.textContent=String(e.exp)),r&&(r.textContent=String(e.maxEXP)),c&&(c.textContent=String(this.game.player.gold)),m&&(m.textContent=String(this.game.floor));const p=Math.max(0,e.hp/e.maxHP*100),f=Math.max(0,e.exp/e.maxEXP*100);h&&(h.style.width=`${p}%`),g&&(g.style.width=`${f}%`),this.renderKillProgress(),this.renderEquipment()}renderKillProgress(){const e=this.game.getMonstersToAdvance(),t=Math.min(this.game.killed,e),s=o("killProgress");s&&(s.textContent=`${t}/${e}`,this.game.killed>=e?s.classList.add("complete"):s.classList.remove("complete"))}renderEquipment(){const e=o("playerWeapon"),t=o("playerArmor");if(this.game.player.weapon){const s=this.game.config.equipment.weapons.find(i=>i.id===this.game.player.weapon);e&&(e.textContent=s?s.name:"æ— ")}else e&&(e.textContent="æ— ");if(this.game.player.armor){const s=this.game.config.equipment.armors.find(i=>i.id===this.game.player.armor);t&&(t.textContent=s?s.name:"æ— ")}else t&&(t.textContent="æ— ")}renderMonster(){if(!this.game.monster)return;const e=o("monsterAvatar"),t=o("monsterName"),s=o("monsterHP"),i=o("monsterMaxHP"),a=o("monsterHPFill");e&&(e.textContent=this.game.monster.avatar),t&&(t.textContent=this.game.monster.name),s&&(s.textContent=String(Math.max(0,this.game.monster.hp))),i&&(i.textContent=String(this.game.monster.maxHP)),a&&(a.style.width=`${Math.max(0,this.game.monster.hp/this.game.monster.maxHP*100)}%`)}setButtons({attack:e,skill:t,item:s,next:i}){const a=o("btnAttack"),n=o("btnSkill"),l=o("btnItem"),r=o("btnNextFloor");if(a&&(a.disabled=e),n&&(n.disabled=t),l&&(l.disabled=s),r){const c=i&&!this.game.canAdvanceFloor;r.disabled=c,this.game.canAdvanceFloor&&!i?r.classList.add("can-advance"):r.classList.remove("can-advance")}}updatePostBattleUI(){this.game.canAdvanceFloor=this.game.killed>=this.game.getMonstersToAdvance(),this.setButtons({attack:!0,skill:!0,item:!0,inventory:!1,next:!this.game.canAdvanceFloor})}updateSkillName(){const e=this.game.player.selectedSkill||this.game.player.learnedSkills[0],t=o("btnSkill"),s=o("currentSkillName");if(t&&s){if(e){const i=this.game.config.skills.find(a=>a.id===e);if(i){const a=this.game.player.skillCooldowns[e]||0;a>0?(s.textContent=`${i.name} (CD:${a})`,t.classList.add("on-cooldown")):(s.textContent=i.name,t.classList.remove("on-cooldown"));return}}s.textContent="æ— æŠ€èƒ½",t.classList.remove("on-cooldown")}}showLevelUp(e,t){const s=o("newLevel"),i=o("levelUpHP"),a=o("levelUpATK"),n=o("levelUpDEF"),l=o("levelUpModal");s&&(s.textContent=String(e)),i&&(i.textContent=`+${t.hp}`),a&&(a.textContent=`+${t.atk}`),n&&(n.textContent=`+${t.def}`),l&&l.classList.add("show")}closeLevelUpModal(){const e=o("levelUpModal");e&&e.classList.remove("show")}openInventory(){this.renderInventoryPanel();const e=o("inventoryModal");e&&e.classList.add("show")}renderInventoryPanel(){const e=[...this.game.config.items.consumables,...this.game.config.items.materials,...this.game.config.items.scrolls];let t=`<div class="inventory-header">
      <span>ğŸ’ èƒŒåŒ… (${this.game.inventory.items.length}/${this.game.inventory.slots})</span>`;if(this.game.inventory.slots<this.game.config.inventory.maxSlots){const i=this.game.inventoryManager.getUnlockCost();t+=`<button class="btn-unlock" onclick="game.unlockSlot()">ğŸ”“ æ‰©å…… (${i}ğŸ’°)</button>`}t+='</div><div class="inventory-grid">',this.game.inventory.items.forEach((i,a)=>{const n=e.find(l=>l.id===i.id);n&&(t+=`<div class="inv-item" onclick="game.showItemDetail(${a})">
        <span class="inv-icon">${n.icon}</span>
        <span class="inv-name">${n.name}</span>
        <span class="inv-count">x${i.count}</span>
      </div>`)}),this.game.inventory.items.length===0&&(t+='<p class="empty-inv">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</p>'),t+="</div>";const s=o("inventoryContent");s&&(s.innerHTML=t)}showItemDetail(e){const t=this.game.inventory.items[e];if(!t)return;const i=[...this.game.config.items.consumables,...this.game.config.items.materials,...this.game.config.items.scrolls].find(c=>c.id===t.id);if(!i)return;let a=`<div class="item-detail">
      <h3>${i.icon} ${i.name} x${t.count}</h3>`;const n=i,l=i;if(n.heal)a+=`<p>æ¢å¤ ${n.heal} HP</p>`,!this.game.inBattle&&this.game.player.hp<this.game.player.maxHP?a+=`<button class="btn btn-use" onclick="game.useItem(${e})">ä½¿ç”¨</button>`:this.game.inBattle?a+='<p class="hint">æˆ˜æ–—ä¸­æ— æ³•ä½¿ç”¨</p>':a+='<p class="hint">ç”Ÿå‘½å·²æ»¡</p>';else if(l.skill){const c=this.game.config.skills.find(m=>m.id===l.skill);c&&this.game.player.learnedSkills.includes(l.skill)?a+=`<p class="hint">å·²å­¦ä¼š ${c.name}</p>`:c&&(a+=`<p>å­¦ä¹ æŠ€èƒ½ï¼š${c.icon} ${c.name}</p>`,a+=`<button class="btn btn-use" onclick="game.learnScroll(${e})">å­¦ä¹ </button>`)}else a+='<p class="hint">é”»é€ ææ–™</p>';a+="</div>";const r=o("inventoryContent");r&&(r.innerHTML=a)}openItemMenu(){if(!this.game.inBattle)return;const e=this.game.inventory.items.filter(a=>{const n=this.game.config.items.consumables.find(l=>l.id===a.id);return n&&n.heal});let t="";e.length===0?t='<p class="no-items">æ²¡æœ‰å¯ä½¿ç”¨çš„é“å…·</p>':(t='<div class="item-options">',e.forEach(a=>{const n=this.game.config.items.consumables.find(l=>l.id===a.id);n&&(t+=`<div class="item-option" onclick="game.useItemInBattle('${a.id}')">
            <span class="item-icon">${n.icon}</span>
            <span class="item-name">${n.name}</span>
            <span class="item-count">x${a.count}</span>
            <span class="item-effect">+${n.heal} HP</span>
          </div>`)}),t+="</div>");const s=o("itemList"),i=o("itemModal");s&&(s.innerHTML=t),i&&i.classList.add("show")}openSkillMenu(){const e=this.game.player.learnedSkills,t=this.game.player.selectedSkill||e[0];let s='<div class="skill-select-list">';e.forEach(n=>{const l=this.game.config.skills.find(m=>m.id===n);if(!l)return;const r=this.game.player.skillCooldowns[n]||0,c=n===t;s+=`<div class="skill-select-item ${c?"selected":""}">
        <span class="skill-info">${l.icon} ${l.name}${r>0?` (${r})`:""}</span>
        <button class="btn-small ${c?"btn-selected":""}" onclick="game.selectSkill('${n}')">${c?"å·²é€‰":"é€‰æ‹©"}</button>
      </div>`}),s+="</div>",e.length===0&&(s='<p style="color:#a0a0a0;text-align:center;">è¿˜æ²¡æœ‰å­¦ä¼šæŠ€èƒ½</p>');const i=o("skillMenuContent"),a=o("skillModal");i&&(i.innerHTML=s),a&&a.classList.add("show")}openSkillManage(){const e=o("skillModal");e&&e.classList.remove("show");const t=this.game.player.learnedSkills,s=this.game.player.equippedSkills,i=this.game.playerManager.getUnlockedSkillSlots();let a=`<p class="slot-info">å·²è§£é” ${i} ä¸ªæŠ€èƒ½æ§½</p>`;a+='<div class="skill-manage-grid">';for(let r=0;r<4;r++){const c=r<i,m=s[r],h=m?this.game.config.skills.find(g=>g.id===m):null;if(a+=`<div class="skill-slot ${c?"":"locked"}">`,c)h?(a+=`<span>${h.icon} ${h.name}</span>`,a+=`<button class="btn-small" onclick="game.unequipSkill(${r})">å¸ä¸‹</button>`):a+='<span class="empty">ç©ºæ§½ä½</span>';else{const g=this.game.config.player.skillSlots[r];a+=`<span class="locked">ğŸ”’ Lv${g}è§£é”</span>`}a+="</div>"}a+="</div>",a+='<h4 style="margin: 12px 0 8px; color: var(--accent);">å·²å­¦æŠ€èƒ½</h4><div class="learned-skills">',t.forEach(r=>{if(s.includes(r))return;const c=this.game.config.skills.find(m=>m.id===r);c&&(a+=`<div class="skill-item">
        <span>${c.icon} ${c.name}</span>
        <button class="btn-small" onclick="game.equipSkill('${r}')">è£…å¤‡</button>
      </div>`)}),a+="</div>";const n=o("skillManageContent"),l=o("skillManageModal");n&&(n.innerHTML=a),l&&l.classList.add("show")}openForge(){this.renderForgePanel();const e=o("forgeModal");e&&e.classList.add("show")}renderForgePanel(){let e='<div class="forge-tabs">';e+=`<button class="tab-btn active" onclick="game.showForgeCategory('weapons')">âš”ï¸ æ­¦å™¨</button>`,e+=`<button class="tab-btn" onclick="game.showForgeCategory('armors')">ğŸ›¡ï¸ ç”²èƒ„</button>`,e+="</div>",e+='<div id="forgeList"></div>';const t=o("forgeContent");t&&(t.innerHTML=e),this.showForgeCategory("weapons")}showForgeCategory(e){document.querySelectorAll(".forge-tabs .tab-btn").forEach((n,l)=>{n.classList.toggle("active",e==="weapons"&&l===0||e==="armors"&&l===1)});const t=this.game.config.equipment[e],s=e==="weapons"?this.game.player.weapon:this.game.player.armor;let i='<div class="forge-list">';t.forEach(n=>{const l=s===n.id,r=this.game.inventoryManager.canForge(n);i+=`<div class="forge-item ${l?"equipped":""}">`,i+=`<div class="forge-info">
        <span class="forge-icon">${n.icon}</span>
        <span class="forge-name">${n.name}</span>
        <span class="forge-stat">${e==="weapons"?`ATK+${n.atk}`:`DEF+${n.def}`}</span>
        ${l?'<span class="equipped-badge">å·²è£…å¤‡</span>':""}
      </div>`,i+='<div class="forge-mats">',Object.entries(n.materials).forEach(([c,m])=>{const h=this.game.config.items.materials.find(f=>f.id===c),g=this.game.inventoryManager.getItemCount(c),p=g>=m;i+=`<span class="mat ${p?"":"lack"}">${h?h.icon:"?"} ${g}/${m}</span>`}),i+="</div>",l?i+=`<button class="btn btn-unequip" onclick="game.unequipItem('${e}')">å¸ä¸‹</button>`:r?i+=`<button class="btn btn-forge" onclick="game.forgeItem('${e}', '${n.id}')">é”»é€ </button>`:i+='<button class="btn btn-forge disabled" disabled>ææ–™ä¸è¶³</button>',i+="</div>"}),i+="</div>";const a=o("forgeList");a&&(a.innerHTML=i)}showConfirm(e,t){const s=o("confirmMessage"),i=o("confirmBtn"),a=o("confirmModal");s&&(s.textContent=e),i&&(i.onclick=()=>{this.closeConfirm(),t()}),a&&a.classList.add("show")}closeConfirm(){const e=o("confirmModal");e&&e.classList.remove("show")}openSettings(){const e=o("settingsModal");e&&e.classList.add("show")}closeAllModals(){document.querySelectorAll(".modal").forEach(e=>e.classList.remove("show"))}updateBattleBackground(e){const t=this.game.storyManager.getWorldLore(e),s=document.querySelector(".battle-area");s&&t&&(s.className=`battle-area ${t.bgClass}`)}showLoreModal(e,t){const s=o("loreIcon"),i=o("loreTitle"),a=o("loreDescription"),n=o("loreContent"),l=o("storyModal");s&&(s.textContent=e.icon),i&&(i.textContent=`${e.name} - ç¬¬${t}å±‚`),a&&(a.textContent=e.description),n&&(n.textContent=e.lore),l&&l.classList.add("show")}closeStoryModal(){const e=o("storyModal");e&&e.classList.remove("show")}showNPCModal(e){const t=o("npcAvatar"),s=o("npcName"),i=o("npcGreeting"),a=o("npcDialogue"),n=o("npcActions"),l=o("npcModal");t&&(t.textContent=e.avatar),s&&(s.textContent=e.name),i&&(i.textContent=e.greeting);const r=this.game.storyManager.getNPCDialogue(e);a&&(a.textContent=r);let c="";e.shop&&e.shop.length>0&&(c='<div class="npc-shop">',e.shop.forEach(m=>{const h=this.game.config.items.consumables.find(g=>g.id===m.itemId)||this.game.config.items.scrolls.find(g=>g.id===m.itemId);if(h){const g=this.game.player.gold>=m.price;c+=`<div class="shop-item ${g?"":"disabled"}" onclick="${g?`game.buyNPCItem('${e.id}', '${m.itemId}')`:""}">
            <span>${h.icon} ${h.name}</span>
            <span>${m.price}ğŸ’°</span>
          </div>`}}),c+="</div>"),e.reward&&(c+=`<button class="btn btn-primary" onclick="game.acceptNPCReward('${e.id}')">æ¥å—å¸®åŠ©</button>`),c+='<button class="btn btn-secondary" onclick="game.closeNPCModal()">ç¦»å¼€</button>',n&&(n.innerHTML=c),l&&l.classList.add("show")}closeNPCModal(){const e=o("npcModal");e&&e.classList.remove("show")}showEventModal(e,t){const s=o("eventIcon"),i=o("eventName"),a=o("eventDescription"),n=o("eventResult"),l=o("eventModal");s&&(s.textContent=e.icon),i&&(i.textContent=e.name),a&&(a.textContent=e.description);let r="";t.lore&&(r+=`<p class="event-lore">${t.lore}</p>`),t.gold>0&&(r+=`<p>ğŸ’° è·å¾— ${t.gold} é‡‘å¸</p>`),t.exp>0&&(r+=`<p>â­ è·å¾— ${t.exp} ç»éªŒ</p>`),t.heal>0&&(r+=`<p>ğŸ’š æ¢å¤ ${t.heal} ç”Ÿå‘½</p>`),t.items&&t.items.length>0&&t.items.forEach(c=>{const m=this.game.config.items.consumables.find(h=>h.id===c.itemId)||this.game.config.items.scrolls.find(h=>h.id===c.itemId);m&&(r+=`<p>ğŸ è·å¾— ${m.icon} ${m.name}</p>`)}),n&&(n.innerHTML=r),l&&l.classList.add("show")}closeEventModal(){const e=o("eventModal");e&&e.classList.remove("show")}}class S{config;floor=1;killed=0;monster=null;inBattle=!1;slowEffect=0;canAdvanceFloor=!1;player;inventory;ui;battle;playerManager;inventoryManager;storyManager;constructor(e){this.config=e,this.ui=new M(this),this.battle=new k(this),this.playerManager=new u(this),this.inventoryManager=new y(this),this.storyManager=new v(this)}init(){this.load(),this.bindEvents(),this.ui.updateSkillName(),this.ui.render(),setTimeout(()=>this.explore(),300)}save(){const e={player:this.player,floor:this.floor,killed:this.killed,inventory:this.inventory,story:this.storyManager.save()};localStorage.setItem("loopingEveSave",JSON.stringify(e))}load(){const e=localStorage.getItem("loopingEveSave");if(e){const t=JSON.parse(e);this.player=t.player,this.floor=t.floor,this.killed=t.killed,this.inventory=t.inventory||{slots:this.config.inventory.initialSlots,items:[]},this.playerManager.migrateOldData(),this.storyManager.load(t.story),this.canAdvanceFloor=this.killed>=this.getMonstersToAdvance()}else this.playerManager.init(),this.inventoryManager.init()}bindEvents(){const e=o("btnAttack"),t=o("btnSkill"),s=o("btnItem"),i=o("btnNextFloor"),a=o("btnSettings"),n=o("btnClear2");e&&(e.onclick=()=>this.battle.attack()),t&&(t.onclick=()=>this.battle.useSelectedSkill()),s&&(s.onclick=()=>this.inventoryManager.smartUseItem()),i&&(i.onclick=()=>this.nextFloor()),a&&(a.onclick=()=>this.ui.openSettings()),n&&(n.onclick=()=>{const l=o("settingsModal");l&&l.classList.remove("show"),this.ui.showConfirm("ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼",()=>this.clearSave())})}clearSave(){localStorage.removeItem("loopingEveSave"),this.playerManager.init(),this.inventoryManager.init(),this.storyManager.reset(),this.floor=1,this.killed=0,this.monster=null,this.inBattle=!1,this.slowEffect=0,this.canAdvanceFloor=!1;const e=o("battleLog");e&&(e.innerHTML="<p>å­˜æ¡£å·²æ¸…é™¤ï¼Œç‚¹å‡»ã€Œæ¢ç´¢ã€å¼€å§‹ï¼</p>"),this.ui.setButtons({attack:!0,skill:!0,item:!0,inventory:!1,next:!0}),this.ui.updateBattleBackground(1),this.ui.render(),this.ui.closeAllModals()}nextFloor(){const e=this.floor;this.floor++,this.killed=0,this.ui.log(`ğŸ“ è¿›å…¥ç¬¬ ${this.floor} å±‚ï¼`);const t=o("btnNextFloor");t&&(t.disabled=!0),this.ui.updateBattleBackground(this.floor);const s=this.storyManager.onFloorAdvance(this.floor,e);s&&this.ui.showLoreModal(s.data,this.floor);const i=this.storyManager.checkNPC(this.floor);i&&setTimeout(()=>{this.ui.showNPCModal(i.data)},s?2e3:500),this.save(),this.ui.render()}getMonstersToAdvance(){const e=this.config.floor.monstersToAdvance,t=this.config.floor.maxMonsters||10,s=this.floor;return s<=5?e:s<=10?Math.min(e+1,t):s<=20?Math.min(e+2,t):Math.min(e+3,t)}handleAutoNext(){const t=o("autoNext")?.checked??!1;setTimeout(()=>{this.canAdvanceFloor&&t?(this.nextFloor(),setTimeout(()=>this.battle.explore(),300)):this.battle.explore()},500)}gameOver(){localStorage.removeItem("loopingEveSave");const e=o("finalFloor"),t=o("finalLevel"),s=o("finalGold"),i=o("gameOverModal");e&&(e.textContent=String(this.floor)),t&&(t.textContent=String(this.player.level)),s&&(s.textContent=String(this.player.gold)),i&&i.classList.add("show")}restart(){this.playerManager.init(),this.inventoryManager.init(),this.storyManager.reset(),this.floor=1,this.killed=0,this.monster=null,this.inBattle=!1,this.slowEffect=0,localStorage.removeItem("loopingEveSave");const e=o("gameOverModal"),t=o("battleLog");e&&e.classList.remove("show"),t&&(t.innerHTML="<p>æ¸¸æˆå¼€å§‹ï¼</p>"),this.ui.setButtons({attack:!0,skill:!0,item:!0,inventory:!1,next:!0}),this.ui.updateBattleBackground(1),this.ui.render(),setTimeout(()=>this.explore(),500)}explore(){this.battle.explore()}attack(){this.battle.attack()}useSkill(e){this.battle.useSkill(e)}useFirstSkill(){this.battle.useSelectedSkill()}useItem(e){this.inventoryManager.useItem(e)}useItemInBattle(e){this.inventoryManager.useItemInBattle(e)}smartUseItem(){this.inventoryManager.smartUseItem()}learnScroll(e){this.inventoryManager.learnScroll(e)}unlockSlot(){this.inventoryManager.unlockSlot()}openInventory(){this.ui.openInventory()}openItemMenu(){this.ui.openItemMenu()}openSkillMenu(){this.ui.openSkillMenu()}openSkillManage(){this.ui.openSkillManage()}openForge(){this.ui.openForge()}showForgeCategory(e){this.ui.showForgeCategory(e)}forgeItem(e,t){this.inventoryManager.forgeItem(e,t)}unequipItem(e){this.playerManager.unequipItem(e),this.save(),this.ui.render(),this.ui.showForgeCategory(e),this.ui.log("ğŸ“¤ å·²å¸ä¸‹è£…å¤‡")}equipSkill(e){const t=this.playerManager.equipSkill(e),s=this.config.skills.find(i=>i.id===e);t&&s&&this.ui.log(`âš ï¸ ${t} å·²è¢«æ›¿æ¢ä¸º ${s.name}`),this.save(),this.ui.updateSkillName(),this.ui.openSkillManage()}unequipSkill(e){this.playerManager.unequipSkill(e),this.save(),this.ui.updateSkillName(),this.ui.openSkillManage()}selectSkill(e){this.player.selectedSkill=e,this.save(),this.ui.updateSkillName(),this.ui.openSkillMenu()}closeLevelUpModal(){this.ui.closeLevelUpModal()}closeStoryModal(){this.ui.closeStoryModal()}closeNPCModal(){this.ui.closeNPCModal()}closeEventModal(){this.ui.closeEventModal()}buyNPCItem(e,t){const s=this.config.npcs.find(a=>a.id===e);if(!s||!s.shop)return;const i=s.shop.find(a=>a.itemId===t);if(i){if(this.player.gold<i.price){this.ui.log("ğŸ’° é‡‘å¸ä¸è¶³ï¼");return}this.player.gold-=i.price,this.inventoryManager.addItem(t,1),this.ui.log("ğŸ’° è´­ä¹°äº†ç‰©å“ï¼"),this.save(),this.ui.render()}}acceptNPCReward(e){const t=this.config.npcs.find(i=>i.id===e);if(!t)return;const s=this.storyManager.processNPCReward(t);this.storyManager.applyReward(s),this.ui.closeNPCModal(),s.gold>0&&this.ui.log(`ğŸ’° è·å¾— ${s.gold} é‡‘å¸`),s.exp>0&&this.ui.log(`â­ è·å¾— ${s.exp} ç»éªŒ`),s.items.length>0&&this.ui.log("ğŸ è·å¾—ç‰©å“"),this.save(),this.ui.render()}showConfirm(e,t){this.ui.showConfirm(e,t)}closeConfirm(){this.ui.closeConfirm()}showItemDetail(e){this.ui.showItemDetail(e)}}async function w(){const e=await fetch("./MainGame/dist/"+"Configs/config.json?t="+Date.now());if(!e.ok)throw new Error("é…ç½®åŠ è½½å¤±è´¥");return e.json()}function b(d){document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&(e.id==="gameOverModal"?d.restart():e.classList.remove("show"))})})}w().then(d=>{const e=new S(d);window.game=e,e.init(),b(e)}).catch(d=>{alert("é…ç½®åŠ è½½å¤±è´¥ï¼š"+d.message)});
//# sourceMappingURL=index.D-vQh6PZ.js.map
